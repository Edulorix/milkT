<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0f172a" />
  <meta name="description" content="ì„œì /ë§ˆíŠ¸ ê·¼ë¬´ ìŠ¤ì¼€ì¤„ì„ ì£¼ì°¨ë³„ë¡œ ê´€ë¦¬í•˜ê³ , URL ê³µìœ  ë° ì´ë¯¸ì§€(PNG)ë¡œ ë‚´ë³´ë‚¼ ìˆ˜ ìˆëŠ” ì›¹ ì•±" />
  <title>ê·¼ë¬´ ìŠ¤ì¼€ì¤„ ê´€ë¦¬</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />

  <!-- html2canvas for PNG export -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <style>
    :root{
      /* Light, high-contrast theme for readability (40~50ëŒ€ ê°€ë…ì„±) */
      --bg: #f6f7fb;
      --panel: #ffffff;
      --card: #ffffff;
      --card2: #f3f4f6;
      --text: rgba(17,24,39,.95); /* gray-900 */
      --muted: rgba(55,65,81,.80); /* gray-700 */
      --muted2: rgba(107,114,128,.90); /* gray-500 */
      --border: rgba(17,24,39,.12);
      --border2: rgba(17,24,39,.08);
      --accent: #2563eb; /* blue-600 */
      --danger: #dc2626; /* red-600 */
      --warn: #d97706; /* amber-600 */
      --ok: #16a34a; /* green-600 */

      --bookstore: #E3F2FD;
      --mart: #F1F8E9;
      --other: #F5F5F5;
      --off: #F5F5F5;

      --sat: #fff7ed;
      --sun: #fff1f2;
      --holiday: #dc2626;

      --shadow: 0 10px 30px rgba(17,24,39,.10);
      --radius: 16px;

      --cell-min-h: 58px;
      --font: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple SD Gothic Neo", "Noto Sans KR", sans-serif;
    }

    *{ box-sizing: border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      background:
        radial-gradient(1000px 600px at 10% -10%, rgba(37,99,235,.12), transparent 60%),
        radial-gradient(900px 540px at 90% 0%, rgba(22,163,74,.10), transparent 60%),
        linear-gradient(180deg, var(--bg) 0%, #ffffff 60%, var(--bg) 100%);
      color: var(--text);
      font-family: var(--font);
      letter-spacing: -0.2px;
    }

    a{ color: inherit; }

    .app{
      max-width: 1200px;
      margin: 0 auto;
      padding: 18px 14px 110px;
    }

    header{
      position: sticky;
      top: 0;
      z-index: 30;
      backdrop-filter: blur(10px);
      background: rgba(246,247,251,.85);
      border-bottom: 1px solid var(--border2);
    }

    .topbar{
      max-width: 1200px;
      margin: 0 auto;
      padding: 14px 14px 10px;
      display:flex;
      gap: 12px;
      align-items: center;
      justify-content: space-between;
    }

    .brand{
      display:flex;
      gap: 10px;
      align-items: center;
      min-width: 260px;
    }
    .logo{
      width: 40px; height: 40px;
      border-radius: 12px;
      background: linear-gradient(135deg, rgba(37,99,235,.95), rgba(14,165,233,.65));
      box-shadow: 0 10px 24px rgba(37,99,235,.18);
      display:grid; place-items:center;
      font-weight: 900;
    }
    .brand h1{ font-size: 18px; margin:0; line-height: 1.1; }
    .brand .sub{ font-size: 12px; color: var(--muted); margin-top: 3px; }

    .actions{
      display:flex;
      gap: 10px;
      align-items: center;
      justify-content: flex-end;
      flex-wrap: wrap;
    }

    .pill{
      display:flex;
      align-items:center;
      gap: 8px;
      padding: 10px 12px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.9);
      border-radius: 999px;
      cursor:pointer;
      user-select:none;
      font-weight: 800;
      font-size: 14px;
    }
    .pill:active{ transform: translateY(1px); }

    .badge{
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.05);
      color: var(--muted);
    }

    .nav{
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 14px 12px;
      display:flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }

    .tab{
      border: 1px solid var(--border);
      background: rgba(255,255,255,.85);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 900;
      font-size: 14px;
    }
    .tab[aria-selected="true"]{
      background: linear-gradient(135deg, rgba(37,99,235,.18), rgba(255,255,255,.95));
      border-color: rgba(37,99,235,.45);
      box-shadow: 0 8px 18px rgba(37,99,235,.12);
    }

    .panel{
      margin-top: 14px;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      background: var(--panel);
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    .panelHeader{
      padding: 14px 14px;
      display:flex;
      gap: 10px;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid var(--border2);
      flex-wrap: wrap;
    }

    .panelHeader .title{
      display:flex;
      gap: 12px;
      align-items: baseline;
      flex-wrap: wrap;
    }
    .panelHeader .title h2{ margin:0; font-size: 16px; }
    .panelHeader .title .meta{ color: var(--muted); font-size: 13px; }

    .panelHeader .controls{
      display:flex;
      gap: 10px;
      align-items:center;
      flex-wrap: wrap;
    }

    select, input[type="text"], input[type="password"], input[type="date"], input[type="color"], input[type="month"], textarea{
      font: inherit;
      color: var(--text);
      background: rgba(255,255,255,.95);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px 12px;
      outline: none;
    }
    select:focus, input:focus, textarea:focus{ border-color: rgba(124,58,237,.7); }

    .btn{
      font: inherit;
      font-weight: 900;
      border-radius: 12px;
      padding: 10px 12px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.95);
      color: var(--text);
      cursor: pointer;
    }
    .btn.primary{ background: rgba(37,99,235,.12); border-color: rgba(37,99,235,.45); }
    .btn.danger{ background: rgba(220,38,38,.10); border-color: rgba(220,38,38,.35); }
    .btn.ghost{ background: transparent; }
    .btn:active{ transform: translateY(1px); }

    .hint{ color: var(--muted); font-size: 12px; line-height: 1.4; }

    .content{ padding: 14px; }

    /* Schedule grid */
    .gridWrap{ overflow:auto; }

    table{
      border-collapse: separate;
      border-spacing: 0;
      width: 100%;
      min-width: 900px;
    }

    th, td{
      border-right: 1px solid rgba(255,255,255,.10);
      border-bottom: 1px solid rgba(255,255,255,.10);
      padding: 10px;
      vertical-align: top;
      background: rgba(0,0,0,0);
    }

    thead th{
      position: sticky;
      top: 0;
      z-index: 10;
      background: rgba(255,255,255,.92);
      backdrop-filter: blur(8px);
      text-align: left;
      font-size: 13px;
    }

    th:first-child, td:first-child{
      position: sticky;
      left: 0;
      z-index: 9;
      background: rgba(255,255,255,.96);
      backdrop-filter: blur(8px);
    }

    thead th:first-child{ z-index: 12; }

    .placeCell{
      min-width: 260px;
    }

    .placeName{ font-weight: 900; font-size: 14px; }
    .placeMeta{ font-size: 12px; color: var(--muted); margin-top: 2px; }

    .dayHead{
      min-width: 150px;
    }
    .dow{ display:block; font-size: 12px; color: var(--muted2); margin-top: 2px; }
    .date{ font-weight: 900; }

    .cell{
      min-height: var(--cell-min-h);
      border-radius: 12px;
      border: 1px dashed rgba(17,24,39,.18);
      background: rgba(255,255,255,.92);
      padding: 8px;
      cursor: pointer;
    }
    .cell[aria-disabled="true"]{ cursor: default; opacity: .92; }

    .cellHeader{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 6px;
    }

    .tags{ display:flex; flex-wrap: wrap; gap: 6px; }

    .tag{
      display:inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 8px;
      border-radius: 999px;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.12);
      font-size: 12px;
      font-weight: 800;
      color: var(--text);
      user-select:none;
      max-width: 100%;
    }
    .tag .dot{ width: 10px; height: 10px; border-radius: 50%; background: rgba(255,255,255,.75); flex: 0 0 auto; }
    .tag .name{ white-space: nowrap; overflow:hidden; text-overflow: ellipsis; }

    .tag.dragging{ opacity: .5; }

    .dropHint{
      font-size: 12px;
      color: var(--muted2);
      margin-top: 6px;
    }

    .cell.warn2{ border-color: rgba(217,119,6,.65); background: rgba(217,119,6,.10); }
    .cell.warn3{ border-color: rgba(234,88,12,.65); background: rgba(234,88,12,.12); }

    /* Category tint on place column */
    .placeTint.bookstore{ background: linear-gradient(180deg, rgba(227,242,253,.85), rgba(255,255,255,.96)); }
    .placeTint.mart{ background: linear-gradient(180deg, rgba(241,248,233,.85), rgba(255,255,255,.96)); }
    .placeTint.other{ background: linear-gradient(180deg, rgba(245,245,245,.85), rgba(255,255,255,.96)); }

    /* weekend tint in header */
    .isSat{ background: rgba(255,237,213,.55) !important; }
    .isSun{ background: rgba(255,228,230,.55) !important; }
    .isHoliday{ background: rgba(254,226,226,.75) !important; }
    .holidayText{ color: var(--holiday) !important; font-weight: 1000; }
    .holidayBadge{ display:inline-block; margin-top:6px; font-size:12px; color: var(--holiday); font-weight: 900; }

    /* Views */
    .view{ display:none; }
    .view.active{ display:block; }

    .cards{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 12px;
    }

    .card{
      grid-column: span 12;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.05);
      border-radius: 16px;
      padding: 14px;
    }

    @media (min-width: 900px){
      .card.half{ grid-column: span 6; }
      .card.third{ grid-column: span 4; }
    }

    .card h3{ margin: 0 0 10px; font-size: 15px; }

    .list{
      display:flex;
      flex-direction: column;
      gap: 8px;
    }

    .item{
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      border-radius: 14px;
      padding: 10px 12px;
      display:flex;
      justify-content: space-between;
      gap: 12px;
      align-items: flex-start;
    }

    .item .left{ min-width: 0; }
    .item .right{ display:flex; gap: 8px; align-items:center; flex-wrap: wrap; }
    .item .title{ font-weight: 900; }
    .item .sub{ font-size: 12px; color: var(--muted); margin-top: 2px; }

    .kpi{
      display:flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-top: 8px;
    }
    .kpi .box{
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      border-radius: 14px;
      padding: 10px 12px;
      min-width: 140px;
    }
    .kpi .num{ font-weight: 1000; font-size: 20px; }
    .kpi .lbl{ font-size: 12px; color: var(--muted); margin-top: 2px; }

    /* Floating Action Button */
    .fab{
      position: fixed;
      right: 16px;
      bottom: 16px;
      z-index: 50;
      display:flex;
      flex-direction: column;
      gap: 10px;
      align-items: flex-end;
    }

    .fabMain{
      width: 56px; height: 56px;
      border-radius: 18px;
      border: 1px solid rgba(17,24,39,.14);
      background: linear-gradient(135deg, rgba(37,99,235,.92), rgba(14,165,233,.60));
      box-shadow: 0 16px 40px rgba(37,99,235,.18);
      color: #fff;
      cursor: pointer;
      font-weight: 1000;
      font-size: 18px;
    }

    .fabMenu{ display:none; flex-direction: column; gap: 10px; align-items: flex-end; }
    .fab.open .fabMenu{ display:flex; }

    .fabBtn{
      display:flex;
      align-items:center;
      gap: 10px;
      border-radius: 16px;
      padding: 10px 12px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.96);
      color: var(--text);
      cursor: pointer;
      min-width: 210px;
      justify-content: space-between;
    }

    .fabBtn .lbl{ font-weight: 900; }
    .fabBtn .desc{ font-size: 12px; color: var(--muted); }

    /* Modal */
    .modalBackdrop{
      position: fixed;
      inset: 0;
      background: rgba(17,24,39,.35);
      display:none;
      z-index: 60;
      padding: 18px;
      overflow:auto;
    }
    .modalBackdrop.open{ display:block; }

    .modal{
      max-width: 720px;
      margin: 50px auto;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.98);
      border-radius: 18px;
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    .modalHeader{
      padding: 14px 14px;
      border-bottom: 1px solid rgba(255,255,255,.12);
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
    }
    .modalHeader h3{ margin:0; font-size: 16px; }

    .modalBody{ padding: 14px; }
    .modalFooter{
      padding: 14px;
      border-top: 1px solid rgba(255,255,255,.12);
      display:flex;
      justify-content: flex-end;
      gap: 10px;
      flex-wrap: wrap;
    }

    .grid2{
      display:grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }
    @media (min-width: 700px){
      .grid2{ grid-template-columns: 1fr 1fr; }
    }

    .checklist{
      display:grid;
      grid-template-columns: 1fr;
      gap: 8px;
    }
    @media (min-width: 700px){
      .checklist{ grid-template-columns: 1fr 1fr; }
    }

    .check{
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      border-radius: 14px;
      padding: 10px 12px;
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
    }

    .check label{ display:flex; gap: 10px; align-items:center; font-weight: 800; }

    .toast{
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 92px;
      z-index: 80;
      background: rgba(15,23,42,.95);
      border: 1px solid rgba(255,255,255,.18);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 14px;
      box-shadow: var(--shadow);
      display:none;
      max-width: calc(100vw - 24px);
    }
    .toast.show{ display:block; }

    /* Print / export tweak */
    .exportArea{
      background: rgba(255,255,255,.98);
      border-radius: 18px;
      border: 1px solid var(--border);
    }

    /* Small screens */
    @media (max-width: 520px){
      .brand{ min-width: auto; }
      .brand h1{ font-size: 16px; }
      .pill{ padding: 9px 10px; }
      .fabBtn{ min-width: 190px; }
      table{ min-width: 760px; }
    }
  </style>

  <link rel="manifest" href="manifest.webmanifest">
</head>
<body>
  <header>
    <div class="topbar">
      <div class="brand" aria-label="ì•± ì œëª©">
        <div class="logo">ğŸ—“</div>
        <div>
          <h1>ê·¼ë¬´ ìŠ¤ì¼€ì¤„ ê´€ë¦¬</h1>
          <div class="sub">URLë¡œ ê³µìœ  Â· PNGë¡œ ì €ì¥ Â· ì£¼ì°¨ ìë™ ìƒì„±</div>
        </div>
      </div>

      <div class="actions">
        <div class="badge" id="roleBadge">ë³´ê¸° ì „ìš©</div>
        <button class="pill" id="btnShare" title="í˜„ì¬ ì£¼ì†Œë¥¼ ë³µì‚¬í•©ë‹ˆë‹¤">ğŸ”— URL ë³µì‚¬</button>
        <button class="pill" id="btnAdmin" title="ë¹„ë°€ë²ˆí˜¸(1234)ë¡œ í¸ì§‘ ê¶Œí•œ">âœï¸ ê´€ë¦¬ì</button>
      </div>
    </div>

    <nav class="nav" aria-label="ë³´ê¸° ì „í™˜">
      <button class="tab" data-view="week" aria-selected="true">ì „ì²´</button>
      <button class="tab" data-view="person">ê°œì¸ë³„</button>
      <button class="tab" data-view="place">ì¥ì†Œë³„</button>
      <button class="tab" data-view="month">ë‹¬ë ¥</button>
      <button class="tab" data-view="weekCards">ğŸ“±ì¹´ë“œ(ì£¼ê°„)</button>
    </nav>
  </header>

  <main class="app">
    <section class="panel">
      <div class="panelHeader">
        <div class="title">
          <h2 id="weekTitle">ì£¼ê°„ ìŠ¤ì¼€ì¤„</h2>
          <div class="meta" id="weekMeta"></div>
        </div>
        <div class="controls">
          <button class="btn" id="btnPrevWeek">â—€ ì´ì „</button>
          <button class="btn" id="btnToday">ì˜¤ëŠ˜</button>
          <button class="btn" id="btnNextWeek">ë‹¤ìŒ â–¶</button>
          <button class="btn primary" id="btnNewWeek">ğŸ“… ë‹¤ìŒ ì£¼ì°¨ ìƒì„±</button>
          <button class="btn" id="btnExport">ğŸ“¸ PNG ì €ì¥</button>
        </div>
      </div>

      <div class="content">
        <div class="hint" style="margin-bottom:10px;">
          Â· ë³´ê¸° ì „ìš©: íŒ€ì›ë“¤ì€ URLë§Œ ê³µìœ ë°›ì•„ í™•ì¸í•©ë‹ˆë‹¤. Â· í¸ì§‘: ìš°ì¸¡ ìƒë‹¨ <b>ê´€ë¦¬ì</b> ë²„íŠ¼(ë¹„ë°€ë²ˆí˜¸: <b>1234</b>). Â· ë“œë˜ê·¸&ë“œë¡­: íŒ€ì› íƒœê·¸ë¥¼ ì…€ë¡œ ëŒì–´ë‹¤ ë†“ìœ¼ë©´ ë°°ì¹˜ë©ë‹ˆë‹¤(ê´€ë¦¬ì ì „ìš©).<br/>
          <span class="holidayBadge">â— ê³µíœ´ì¼ì€ ë¹¨ê°„ ê¸€ì”¨ë¡œ í‘œì‹œë©ë‹ˆë‹¤(2026ë…„ ê¸°ì¤€).</span>
        </div>

        <div class="view" id="view-weekCards">
          <div class="grid2" style="margin-bottom:12px;">
            <div>
              <label class="hint" for="weekSelectCards">ì£¼ì°¨ ì„ íƒ</label>
              <select id="weekSelectCards" style="width:100%; margin-top:6px;"></select>
            </div>
            <div>
              <label class="hint" for="cardFilterText">ë¹ ë¥¸ í•„í„°(ì¥ì†Œ/íŒ€ì›)</label>
              <input id="cardFilterText" type="text" placeholder="ì˜ˆ: ì¸ì²œ / ê¹€ë‘ë‹ˆ" style="width:100%; margin-top:6px;" />
            </div>
          </div>

          <div class="exportArea" id="exportArea-weekCards">
            <div class="cards" id="weekCards"></div>
          </div>
        </div>

        <div class="view active" id="view-week">
          <div class="grid2" style="margin-bottom:12px;">
            <div>
              <label class="hint" for="weekSelect">ì£¼ì°¨ ì„ íƒ</label>
              <select id="weekSelect" style="width:100%; margin-top:6px;"></select>
            </div>
            <div>
              <label class="hint" for="filterText">ë¹ ë¥¸ í•„í„°(ì¥ì†Œ/íŒ€ì›)</label>
              <input id="filterText" type="text" placeholder="ì˜ˆ: ì¸ì²œ / ê¹€ë‘ë‹ˆ" style="width:100%; margin-top:6px;" />
            </div>
          </div>

          <div class="card" style="margin-bottom:12px;">
            <h3 style="margin-bottom:6px;">ë“œë˜ê·¸í•´ì„œ ë°°ì¹˜ (ê´€ë¦¬ì ì „ìš©)</h3>
            <div class="hint" style="margin-bottom:8px;">íŒ€ì› íƒœê·¸ë¥¼ ì›í•˜ëŠ” ë‚ ì§œ/ì¥ì†Œ ì¹¸ìœ¼ë¡œ ë“œë˜ê·¸í•˜ì„¸ìš”. (ì—¬ëŸ¬ ëª… ë°°ì¹˜ ê°€ëŠ¥)</div>
            <div class="tags" id="memberTags"></div>
          </div>

          <div class="exportArea" id="exportArea-week">
            <div class="gridWrap">
              <div id="weekGrid"></div>
            </div>
          </div>
        </div>

        <div class="view" id="view-person">
          <div class="grid2" style="margin-bottom:12px;">
            <div>
              <label class="hint" for="personSelect">íŒ€ì› ì„ íƒ</label>
              <select id="personSelect" style="width:100%; margin-top:6px;"></select>
            </div>
            <div>
              <label class="hint" for="personWeekSelect">ì£¼ì°¨ ì„ íƒ</label>
              <select id="personWeekSelect" style="width:100%; margin-top:6px;"></select>
            </div>
          </div>
          <div class="exportArea" id="exportArea-person">
            <div class="cards" id="personCards"></div>
          </div>
        </div>

        <div class="view" id="view-place">
          <div class="grid2" style="margin-bottom:12px;">
            <div>
              <label class="hint" for="placeSelect">ì¥ì†Œ ì„ íƒ</label>
              <select id="placeSelect" style="width:100%; margin-top:6px;"></select>
            </div>
            <div>
              <label class="hint" for="placeWeekSelect">ì£¼ì°¨ ì„ íƒ</label>
              <select id="placeWeekSelect" style="width:100%; margin-top:6px;"></select>
            </div>
          </div>
          <div class="exportArea" id="exportArea-place">
            <div class="cards" id="placeCards"></div>
          </div>
        </div>

        <div class="view" id="view-month">
          <div class="grid2" style="margin-bottom:12px;">
            <div>
              <label class="hint" for="monthSelect">ì›” ì„ íƒ</label>
              <input id="monthSelect" type="month" style="width:100%; margin-top:6px;" />
            </div>
            <div>
              <label class="hint">í‘œì‹œ ì˜µì…˜</label>
              <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:6px;">
                <button class="btn" id="btnMonthToday">ì´ë²ˆ ë‹¬</button>
                <button class="btn" id="btnMonthCompact">ê°„ë‹¨íˆ/ìì„¸íˆ</button>
              </div>
            </div>
          </div>
          <div class="exportArea" id="exportArea-month">
            <div class="card" id="monthCalendar"></div>
          </div>
        </div>

        <div class="cards" style="margin-top:12px;">
          <div class="card half">
            <h3>ë°ì´í„° ë°±ì—…/ë³µì›</h3>
            <div class="hint" style="margin-bottom:10px;">ë¸Œë¼ìš°ì €(LocalStorage)ì— ìë™ ì €ì¥ë©ë‹ˆë‹¤. í˜¹ì‹œ ëª°ë¼ ë°±ì—… íŒŒì¼(JSON)ì„ ì£¼ê¸°ì ìœ¼ë¡œ ì €ì¥í•˜ì„¸ìš”.</div>
            <div style="display:flex; gap:10px; flex-wrap:wrap;">
              <button class="btn" id="btnBackup">ğŸ’¾ ë°±ì—…(JSON)</button>
              <label class="btn" for="restoreFile" style="cursor:pointer;">ğŸ“¥ ë³µì›(JSON)</label>
              <input id="restoreFile" type="file" accept="application/json" style="display:none" />
              <button class="btn danger" id="btnReset">ğŸ§¹ ì´ˆê¸°í™”</button>
            </div>
          </div>
          <div class="card half">
            <h3>ì„¤ì •(íŒ€ì›/ì¥ì†Œ ê´€ë¦¬)</h3>
            <div class="hint" style="margin-bottom:10px;">ê´€ë¦¬ì ëª¨ë“œì—ì„œë§Œ ë³€ê²½ ê°€ëŠ¥í•©ë‹ˆë‹¤. (ì¸ì› ë³€ë™ì´ ì¦ì€ íŠ¹ì„± ë°˜ì˜)</div>
            <div style="display:flex; gap:10px; flex-wrap:wrap;">
              <button class="btn" id="btnManageMembers">ğŸ‘¥ íŒ€ì› ê´€ë¦¬</button>
              <button class="btn" id="btnManagePlaces">ğŸ¢ ì¥ì†Œ ê´€ë¦¬</button>
              <button class="btn" id="btnHowTo">ğŸ“– ì‚¬ìš© ë°©ë²•</button>
            </div>
          </div>
        </div>

      </div>
    </section>
  </main>

  <!-- Floating Action Button -->
  <div class="fab" id="fab">
    <div class="fabMenu" aria-label="ë¹ ë¥¸ ë©”ë‰´">
      <button class="fabBtn" id="fabEdit"><span>
        <div class="lbl">âœï¸ í¸ì§‘ ëª¨ë“œ</div><div class="desc">ê´€ë¦¬ì ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ</div></span><span>â†’</span></button>
      <button class="fabBtn" id="fabNewWeek"><span>
        <div class="lbl">ğŸ“… ë‹¤ìŒ ì£¼ì°¨</div><div class="desc">ì£¼ì°¨ í…œí”Œë¦¿ ìƒì„±</div></span><span>â†’</span></button>
      <button class="fabBtn" id="fabPng"><span>
        <div class="lbl">ğŸ“¸ PNG ì €ì¥</div><div class="desc">í˜„ì¬ í™”ë©´ ì´ë¯¸ì§€</div></span><span>â†’</span></button>
      <button class="fabBtn" id="fabBackup"><span>
        <div class="lbl">ğŸ’¾ ë°±ì—…</div><div class="desc">JSON ë‹¤ìš´ë¡œë“œ</div></span><span>â†’</span></button>
      <button class="fabBtn" id="fabSettings"><span>
        <div class="lbl">âš™ï¸ ì„¤ì •</div><div class="desc">íŒ€ì›/ì¥ì†Œ ê´€ë¦¬</div></span><span>â†’</span></button>
    </div>
    <button class="fabMain" id="fabMain" aria-label="ë¹ ë¥¸ ë©”ë‰´ ì—´ê¸°">â‰¡</button>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast" role="status" aria-live="polite"></div>

  <!-- Modal: Admin login -->
  <div class="modalBackdrop" id="modalAdmin">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="adminTitle">
      <div class="modalHeader">
        <h3 id="adminTitle">ê´€ë¦¬ì ëª¨ë“œ</h3>
        <button class="btn ghost" data-close="modalAdmin">ë‹«ê¸°</button>
      </div>
      <div class="modalBody">
        <div class="hint" style="margin-bottom:10px;">ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ë©´ í¸ì§‘ ê¸°ëŠ¥ì´ í™œì„±í™”ë©ë‹ˆë‹¤. (ê¸°ë³¸: <b>1234</b>)</div>
        <div class="grid2">
          <div>
            <label class="hint" for="adminPw">ë¹„ë°€ë²ˆí˜¸</label>
            <input id="adminPw" type="password" placeholder="1234" style="width:100%; margin-top:6px;" />
          </div>
          <div>
            <label class="hint">ìƒíƒœ</label>
            <div style="margin-top:10px; font-weight:900;" id="adminStatus">ë³´ê¸° ì „ìš©</div>
            <div class="hint" id="adminStatusHint">ë¡œê·¸ì¸í•˜ë©´ ì…€ í¸ì§‘/ë“œë˜ê·¸/ì¶”ê°€Â·ì‚­ì œê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.</div>
          </div>
        </div>
      </div>
      <div class="modalFooter">
        <button class="btn danger" id="btnLogout">ë¡œê·¸ì•„ì›ƒ</button>
        <button class="btn primary" id="btnLogin">ë¡œê·¸ì¸</button>
      </div>
    </div>
  </div>

  <!-- Modal: Cell edit -->
  <div class="modalBackdrop" id="modalCell">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="cellTitle">
      <div class="modalHeader">
        <h3 id="cellTitle">ê·¼ë¬´ì ì„ íƒ</h3>
        <button class="btn ghost" data-close="modalCell">ë‹«ê¸°</button>
      </div>
      <div class="modalBody">
        <div class="hint" id="cellMeta" style="margin-bottom:10px;"></div>
        <div class="checklist" id="cellChecklist"></div>
      </div>
      <div class="modalFooter">
        <button class="btn" id="btnClearCell">ë¹„ìš°ê¸°</button>
        <button class="btn primary" id="btnSaveCell">ì €ì¥</button>
      </div>
    </div>
  </div>

  <!-- Modal: Manage members -->
  <div class="modalBackdrop" id="modalMembers">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="membersTitle">
      <div class="modalHeader">
        <h3 id="membersTitle">íŒ€ì› ê´€ë¦¬</h3>
        <button class="btn ghost" data-close="modalMembers">ë‹«ê¸°</button>
      </div>
      <div class="modalBody">
        <div class="hint" style="margin-bottom:10px;">íŒ€ì›ì€ <b>ì¶”ê°€/ì‚­ì œ</b> ë˜ëŠ” <b>í™œì„±/ë¹„í™œì„±</b>ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤. ì‚­ì œí•´ë„ ê³¼ê±° ê¸°ë¡ì€ ê·¸ëŒ€ë¡œ ë‚¨ìŠµë‹ˆë‹¤(ì´ë¦„ë§Œ í‘œì‹œë  ìˆ˜ ìˆìŒ).</div>

        <div class="card" style="margin-bottom:12px;">
          <h3 style="margin-bottom:8px;">ìƒˆ íŒ€ì› ì¶”ê°€</h3>
          <div class="grid2">
            <div>
              <label class="hint" for="newMemberName">ì´ë¦„</label>
              <input id="newMemberName" type="text" placeholder="ì˜ˆ: í™ê¸¸ë™" style="width:100%; margin-top:6px;" />
            </div>
            <div>
              <label class="hint" for="newMemberColor">ìƒ‰ìƒ</label>
              <input id="newMemberColor" type="color" value="#60a5fa" style="width:100%; margin-top:6px; height:44px;" />
            </div>
          </div>
          <div style="margin-top:10px; display:flex; justify-content:flex-end;">
            <button class="btn primary" id="btnAddMember">ì¶”ê°€</button>
          </div>
        </div>

        <div class="card">
          <h3 style="margin-bottom:8px;">í˜„ì¬ íŒ€ì›</h3>
          <div class="list" id="membersList"></div>
        </div>
      </div>
      <div class="modalFooter">
        <button class="btn" data-close="modalMembers">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

  <!-- Modal: Manage places -->
  <div class="modalBackdrop" id="modalPlaces">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="placesTitle">
      <div class="modalHeader">
        <h3 id="placesTitle">ì¥ì†Œ ê´€ë¦¬</h3>
        <button class="btn ghost" data-close="modalPlaces">ë‹«ê¸°</button>
      </div>
      <div class="modalBody">
        <div class="hint" style="margin-bottom:10px;">ì¥ì†ŒëŠ” <b>ì„œì /ë§ˆíŠ¸/ê¸°íƒ€</b>ë¡œ ë¶„ë¥˜ë©ë‹ˆë‹¤. ë¶„ë¥˜ì— ë”°ë¼ ëª©ë¡ê³¼ í—¤ë”ê°€ ìƒ‰ìƒìœ¼ë¡œ êµ¬ë¶„ë©ë‹ˆë‹¤.</div>

        <div class="card" style="margin-bottom:12px;">
          <h3 style="margin-bottom:8px;">ìƒˆ ì¥ì†Œ ì¶”ê°€</h3>
          <div class="grid2">
            <div>
              <label class="hint" for="newPlaceName">ì¥ì†Œëª…</label>
              <input id="newPlaceName" type="text" placeholder="ì˜ˆ: ì˜í’ë¬¸ê³  ì ì‹¤ì " style="width:100%; margin-top:6px;" />
            </div>
            <div>
              <label class="hint" for="newPlaceCat">ë¶„ë¥˜</label>
              <select id="newPlaceCat" style="width:100%; margin-top:6px;">
                <option value="bookstore">ì„œì </option>
                <option value="mart">ë§ˆíŠ¸</option>
                <option value="other">ê¸°íƒ€</option>
              </select>
            </div>
          </div>
          <div style="margin-top:10px; display:flex; justify-content:flex-end;">
            <button class="btn primary" id="btnAddPlace">ì¶”ê°€</button>
          </div>
        </div>

        <div class="card">
          <h3 style="margin-bottom:8px;">í˜„ì¬ ì¥ì†Œ</h3>
          <div class="list" id="placesList"></div>
        </div>
      </div>
      <div class="modalFooter">
        <button class="btn" data-close="modalPlaces">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

  <!-- Modal: HowTo -->
  <div class="modalBackdrop" id="modalHowTo">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="howtoTitle">
      <div class="modalHeader">
        <h3 id="howtoTitle">ì‚¬ìš© ë°©ë²•(ìš”ì•½)</h3>
        <button class="btn ghost" data-close="modalHowTo">ë‹«ê¸°</button>
      </div>
      <div class="modalBody">
        <div class="card">
          <h3>1) íŒ€ì¥(ê´€ë¦¬ì)ë§Œ í¸ì§‘</h3>
          <div class="hint">ìš°ì¸¡ ìƒë‹¨ <b>ê´€ë¦¬ì</b> â†’ ë¹„ë°€ë²ˆí˜¸ <b>1234</b> ì…ë ¥ â†’ ì…€ í´ë¦­/ë“œë˜ê·¸ë¡œ ë°°ì¹˜í•˜ì„¸ìš”.</div>
        </div>
        <div class="card" style="margin-top:10px;">
          <h3>2) íŒ€ì›ì€ URLë¡œ ë³´ê¸°ë§Œ</h3>
          <div class="hint">ìƒë‹¨ <b>URL ë³µì‚¬</b>ë¡œ ë§í¬ë¥¼ ê³µìœ í•˜ë©´, íŒ€ì›ì€ ë³´ê¸° ì „ìš©ìœ¼ë¡œ í™•ì¸í•©ë‹ˆë‹¤.</div>
        </div>
        <div class="card" style="margin-top:10px;">
          <h3>3) PNGë¡œ ì €ì¥í•´ ì¹´í†¡ì— ê³µìœ </h3>
          <div class="hint"><b>PNG ì €ì¥</b> ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ í˜„ì¬ í™”ë©´(ì „ì²´/ê°œì¸/ì¥ì†Œ/ë‹¬ë ¥)ì„ ì´ë¯¸ì§€ë¡œ ì €ì¥í•©ë‹ˆë‹¤.</div>
        </div>
        <div class="card" style="margin-top:10px;">
          <h3>4) ì£¼ì°¨ ìë™ ìƒì„±</h3>
          <div class="hint"><b>ë‹¤ìŒ ì£¼ì°¨ ìƒì„±</b> ë²„íŠ¼ìœ¼ë¡œ ë‹¤ìŒ ì£¼ í…œí”Œë¦¿ì„ ë§Œë“¤ê³ , ì£¼ì°¨ ì„ íƒì—ì„œ ë°”ë¡œ ì´ë™í•˜ì„¸ìš”.</div>
        </div>
        <div class="card" style="margin-top:10px;">
          <h3>5) ë°±ì—…ì€ ê¼­!</h3>
          <div class="hint">ë¸Œë¼ìš°ì € ì €ì¥ì´ë¼, PC/íœ´ëŒ€í°ì´ ë°”ë€Œë©´ ë°ì´í„°ê°€ ì—†ì–´ì§ˆ ìˆ˜ ìˆì–´ìš”. ì£¼ê¸°ì ìœ¼ë¡œ <b>ë°±ì—…(JSON)</b>ì„ ë‹¤ìš´ë¡œë“œí•˜ì„¸ìš”.</div>
        </div>
      </div>
      <div class="modalFooter">
        <button class="btn" data-close="modalHowTo">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

<script>
(() => {
  'use strict';

  // ---------- Constants ----------
  const STORAGE_KEY = 'schedule_app_v1';
  const ADMIN_KEY = 'schedule_admin_v1';
  const ADMIN_PASSWORD = '1234';

  // Google Apps Script Web App (Sheets backend)
  const SHEETS_API_BASE = 'https://script.google.com/macros/s/AKfycbzeRHvFNESvR5JBZ6hdCZyhTOsfYjtki-9jFuGufDZr0P-o6dTxSecGoV_yCw1sqBTk/exec';
  const API_EXPORT_URL = `${SHEETS_API_BASE}?op=export`;
  const API_IMPORT_URL = `${SHEETS_API_BASE}?op=import`;
  const POLL_MS = 15000; // íŒ€ì›ìš© ìë™ ìƒˆë¡œê³ ì¹¨(15ì´ˆ)

  function randId(){
    // small uuid-ish generator safe to call before other functions
    const a = crypto.getRandomValues(new Uint8Array(16));
    a[6] = (a[6] & 0x0f) | 0x40;
    a[8] = (a[8] & 0x3f) | 0x80;
    const hex = [...a].map(b => b.toString(16).padStart(2,'0')).join('');
    return `${hex.slice(0,8)}-${hex.slice(8,12)}-${hex.slice(12,16)}-${hex.slice(16,20)}-${hex.slice(20)}`;
  }

  const DAY_NAMES = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];

  // 2026 ëŒ€í•œë¯¼êµ­ ê³µíœ´ì¼(ê´€ê³µì„œ ê³µíœ´ì¼) - ì£¼ê°„/ë‹¬ë ¥ì—ì„œ ë¹¨ê°„ìƒ‰ í‘œì‹œ
  // NOTE: ëŒ€ì²´ê³µíœ´ì¼ì€ í•´ë‹¹ ì—°ë„ ê·œì •ì— ë”°ë¼ í¬í•¨(2026ë…„ ê¸°ì¤€ ë°˜ì˜)
  const HOLIDAYS_2026 = {
    '2026-01-01': 'ì‹ ì •',
    '2026-02-16': 'ì„¤ë‚  ì—°íœ´',
    '2026-02-17': 'ì„¤ë‚ ',
    '2026-02-18': 'ì„¤ë‚  ì—°íœ´',
    '2026-03-01': 'ì‚¼ì¼ì ˆ',
    '2026-03-02': 'ì‚¼ì¼ì ˆ ëŒ€ì²´ê³µíœ´ì¼',
    '2026-05-05': 'ì–´ë¦°ì´ë‚ ',
    '2026-05-24': 'ë¶€ì²˜ë‹˜ì˜¤ì‹ ë‚ ',
    '2026-05-25': 'ë¶€ì²˜ë‹˜ì˜¤ì‹ ë‚  ëŒ€ì²´ê³µíœ´ì¼',
    '2026-06-06': 'í˜„ì¶©ì¼',
    '2026-08-15': 'ê´‘ë³µì ˆ',
    '2026-09-24': 'ì¶”ì„ ì—°íœ´',
    '2026-09-25': 'ì¶”ì„',
    '2026-09-26': 'ì¶”ì„ ì—°íœ´',
    '2026-10-03': 'ê°œì²œì ˆ',
    '2026-10-09': 'í•œê¸€ë‚ ',
    '2026-12-25': 'í¬ë¦¬ìŠ¤ë§ˆìŠ¤'
  };

  function holidayName(dateKey){
    return HOLIDAYS_2026[dateKey] || '';
  }

  function isHoliday(dateKey){
    return Boolean(HOLIDAYS_2026[dateKey]);
  }

  const DEFAULT_MEMBERS = [
    { id: randId(), name: 'ì§„ì˜í¬', color: '#60a5fa', active: true },
    { id: randId(), name: 'ì„ìŠ¹ì£¼', color: '#a78bfa', active: true },
    { id: randId(), name: 'ê¹€ë‘ë‹ˆ', color: '#34d399', active: true },
    { id: randId(), name: 'ì§€ì •í•˜', color: '#f59e0b', active: true },
    { id: randId(), name: 'ì´ë¯¸ì', color: '#fb7185', active: true },
    { id: randId(), name: 'ë°±ìˆ˜ì—°', color: '#22c55e', active: true },
    { id: randId(), name: 'ì„ê²½ì›', color: '#38bdf8', active: true },
    { id: randId(), name: 'ìµœí˜•ì‹¬', color: '#f472b6', active: true },
    { id: randId(), name: 'ì•ˆì •í¬', color: '#eab308', active: true },
    { id: randId(), name: 'ê¹€ë¯¼ì§€', color: '#94a3b8', active: true },
  ];

  const DEFAULT_PLACES = [
    { id: randId(), name: 'ì˜í’ë¬¸ê³  ì¸ì²œí„°ë¯¸ë„ì ', category: 'bookstore' },
    { id: randId(), name: 'ë°˜ë””ì•¤ë£¨ë‹ˆìŠ¤ ëª©ë™ì ', category: 'bookstore' },
    { id: randId(), name: 'ë”ë¶ ì•ˆì–‘ì—”í„°ì‹ìŠ¤ì ', category: 'bookstore' },
    { id: randId(), name: 'ì˜í’ë¬¸ê³  ì™•ì‹­ë¦¬ì ', category: 'bookstore' },
    { id: randId(), name: 'ì¸ì²œ ìŠ¤í€˜ì–´ì› (10:30-19:00)', category: 'bookstore' },
    { id: randId(), name: 'ë¶ì•¤ë¶ìŠ¤ ê°„ì„í™ˆí”ŒëŸ¬ìŠ¤ì ', category: 'bookstore' },
    { id: randId(), name: 'ì˜í’ë¬¸ê³  ë¶€ì²œí¬ë„ëª°', category: 'bookstore' },
    { id: randId(), name: 'ì˜í’ë¬¸ê³  ê¹€í¬ê³µí•­ì ', category: 'bookstore' },
    { id: randId(), name: 'êµë³´ë¬¸ê³  ì˜ë“±í¬ì ', category: 'bookstore' },
    { id: randId(), name: 'ìš©ì‚° ì˜í’ë¬¸ê³ ', category: 'bookstore' },
    { id: randId(), name: 'ì´ë§ˆíŠ¸ ì‚°ë³¸ì ', category: 'mart' },
    { id: randId(), name: 'ì´ë§ˆíŠ¸ ì˜¤ì‚°ì ', category: 'mart' },
    { id: randId(), name: 'ì´ë§ˆíŠ¸ ì€í‰ì ', category: 'mart' },
    { id: randId(), name: 'ì´ë§ˆíŠ¸ ë‹¤ì‚°ì ', category: 'mart' },
    { id: randId(), name: 'ë¡¯ë°ë§ˆíŠ¸ ì„œìš¸ì—­ì ', category: 'mart' },
  ];

  // One "week" is defined by Monday start (Korean work style)
  const DEFAULT_WEEK_START = new Date(2026, 0, 19); // 2026-01-19 (Mon) ì‹œì‘

  // ---------- State ----------
  let state = migrateState(loadState()) || createDefaultState();
  let lastServerHash = '';
  let pollTimer = null;
  let isSyncing = false;
  let ui = {
    view: 'week',
    weekId: state.weeks[0]?.id,
    personId: null,
    placeId: null,
    filterText: '',
    month: null,
    monthCompact: true,
    editingCell: null, // {weekId, placeId, dateKey}
  };

  // URL params for shareable view state (optional)
  // ---------- Elements ----------
  const el = {
    roleBadge: document.getElementById('roleBadge'),
    btnShare: document.getElementById('btnShare'),
    btnAdmin: document.getElementById('btnAdmin'),

    tabs: Array.from(document.querySelectorAll('.tab')),
    weekTitle: document.getElementById('weekTitle'),
    weekMeta: document.getElementById('weekMeta'),

    btnPrevWeek: document.getElementById('btnPrevWeek'),
    btnNextWeek: document.getElementById('btnNextWeek'),
    btnToday: document.getElementById('btnToday'),
    btnNewWeek: document.getElementById('btnNewWeek'),
    btnExport: document.getElementById('btnExport'),

    weekSelect: document.getElementById('weekSelect'),
    personSelect: document.getElementById('personSelect'),
    placeSelect: document.getElementById('placeSelect'),
    personWeekSelect: document.getElementById('personWeekSelect'),
    placeWeekSelect: document.getElementById('placeWeekSelect'),

    filterText: document.getElementById('filterText'),

    memberTags: document.getElementById('memberTags'),
    weekGrid: document.getElementById('weekGrid'),

    viewWeek: document.getElementById('view-week'),
    viewPerson: document.getElementById('view-person'),
    viewPlace: document.getElementById('view-place'),
    viewMonth: document.getElementById('view-month'),

    personCards: document.getElementById('personCards'),
    placeCards: document.getElementById('placeCards'),

    monthSelect: document.getElementById('monthSelect'),
    btnMonthToday: document.getElementById('btnMonthToday'),
    btnMonthCompact: document.getElementById('btnMonthCompact'),
    monthCalendar: document.getElementById('monthCalendar'),

    btnBackup: document.getElementById('btnBackup'),
    restoreFile: document.getElementById('restoreFile'),
    btnReset: document.getElementById('btnReset'),

    btnManageMembers: document.getElementById('btnManageMembers'),
    btnManagePlaces: document.getElementById('btnManagePlaces'),
    btnHowTo: document.getElementById('btnHowTo'),

    // fab
    fab: document.getElementById('fab'),
    fabMain: document.getElementById('fabMain'),
    fabEdit: document.getElementById('fabEdit'),
    fabNewWeek: document.getElementById('fabNewWeek'),
    fabPng: document.getElementById('fabPng'),
    fabBackup: document.getElementById('fabBackup'),
    fabSettings: document.getElementById('fabSettings'),

    // modals
    modalAdmin: document.getElementById('modalAdmin'),
    adminPw: document.getElementById('adminPw'),
    adminStatus: document.getElementById('adminStatus'),
    btnLogin: document.getElementById('btnLogin'),
    btnLogout: document.getElementById('btnLogout'),

    modalCell: document.getElementById('modalCell'),
    cellMeta: document.getElementById('cellMeta'),
    cellChecklist: document.getElementById('cellChecklist'),
    btnSaveCell: document.getElementById('btnSaveCell'),
    btnClearCell: document.getElementById('btnClearCell'),

    modalMembers: document.getElementById('modalMembers'),
    newMemberName: document.getElementById('newMemberName'),
    newMemberColor: document.getElementById('newMemberColor'),
    btnAddMember: document.getElementById('btnAddMember'),
    membersList: document.getElementById('membersList'),

    modalPlaces: document.getElementById('modalPlaces'),
    newPlaceName: document.getElementById('newPlaceName'),
    newPlaceCat: document.getElementById('newPlaceCat'),
    btnAddPlace: document.getElementById('btnAddPlace'),
    placesList: document.getElementById('placesList'),

    modalHowTo: document.getElementById('modalHowTo'),

    toast: document.getElementById('toast'),

    exportAreas: {
      week: document.getElementById('exportArea-week'),
      weekCards: document.getElementById('exportArea-weekCards'),
      person: document.getElementById('exportArea-person'),
      place: document.getElementById('exportArea-place'),
      month: document.getElementById('exportArea-month'),
    },

    viewWeekCards: document.getElementById('view-weekCards'),
    weekSelectCards: document.getElementById('weekSelectCards'),
    cardFilterText: document.getElementById('cardFilterText'),
    weekCards: document.getElementById('weekCards')
  };

  // ---------- Init ----------
  applyUrlParams();
  ensureWeekExists(ui.weekId);
  hydrateSelectors();
  setView(ui.view); // apply initial view
  refreshAll();
  updateRoleUI();

  // Start sync with Google Sheets
  startPolling();
  // First pull immediately (do not block UI)
  pullFromServer({ force: true }).catch(() => {});

  // ---------- Events ----------
  el.tabs.forEach(btn => {
    btn.addEventListener('click', () => {
      const view = btn.dataset.view;
      setView(view);
    });
  });

  el.btnShare.addEventListener('click', async () => {
    const url = new URL(location.href);
    url.searchParams.set('view', ui.view);
    if (ui.weekId) url.searchParams.set('week', ui.weekId);
    if (ui.personId) url.searchParams.set('person', ui.personId);
    if (ui.placeId) url.searchParams.set('place', ui.placeId);
    try{
      await navigator.clipboard.writeText(url.toString());
      toast('URLì„ ë³µì‚¬í–ˆìŠµë‹ˆë‹¤. íŒ€ì›ì—ê²Œ ê³µìœ í•˜ì„¸ìš”.');
    }catch{
      prompt('ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì•„ë˜ URLì„ ë³µì‚¬í•˜ì„¸ìš”.', url.toString());
    }
  });

  el.btnAdmin.addEventListener('click', () => openModal('modalAdmin'));

  document.querySelectorAll('[data-close]').forEach(btn => {
    btn.addEventListener('click', () => closeModal(btn.dataset.close));
  });

  el.btnLogin.addEventListener('click', () => {
    const pw = el.adminPw.value.trim();
    if (pw === ADMIN_PASSWORD){
      localStorage.setItem(ADMIN_KEY, '1');
      el.adminPw.value = '';
      toast('ê´€ë¦¬ì ëª¨ë“œ í™œì„±í™”');
      updateRoleUI();
      refreshAll();
      // ë¡œê·¸ì¸ ì§í›„ ì„œë²„ì—ì„œ í•œë²ˆ ë‹¹ê²¨ì™€ ìµœì‹  ìƒíƒœ í™•ì¸
      pullFromServer({ force: true }).catch(() => {});
      closeModal('modalAdmin');
    } else {
      toast('ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.');
    }
  });

  el.btnLogout.addEventListener('click', () => {
    localStorage.removeItem(ADMIN_KEY);
    toast('ë¡œê·¸ì•„ì›ƒ(ë³´ê¸° ì „ìš©)');
    updateRoleUI();
    refreshAll();
    // ë³´ê¸° ì „ìš©ìœ¼ë¡œ ì „í™˜ ì‹œ ì„œë²„ ìƒíƒœ ì¬ë™ê¸°í™”
    pullFromServer({ force: true }).catch(() => {});
    closeModal('modalAdmin');
  });

  el.btnPrevWeek.addEventListener('click', () => jumpWeek(-1));
  el.btnNextWeek.addEventListener('click', () => jumpWeek(1));
  el.btnToday.addEventListener('click', () => goToTodayWeek());
  el.btnNewWeek.addEventListener('click', () => createNextWeek());

  el.weekSelect.addEventListener('change', () => {
    ui.weekId = el.weekSelect.value;
    refreshAll();
    syncUrlParams();
  });

  el.weekSelectCards.addEventListener('change', () => {
    ui.weekId = el.weekSelectCards.value;
    refreshAll();
    syncUrlParams();
  });

  el.personWeekSelect.addEventListener('change', () => {
    ui.weekId = el.personWeekSelect.value;
    refreshAll();
    syncUrlParams();
  });

  el.placeWeekSelect.addEventListener('change', () => {
    ui.weekId = el.placeWeekSelect.value;
    refreshAll();
    syncUrlParams();
  });

  el.personSelect.addEventListener('change', () => {
    ui.personId = el.personSelect.value;
    refreshAll();
    syncUrlParams();
  });

  el.placeSelect.addEventListener('change', () => {
    ui.placeId = el.placeSelect.value;
    refreshAll();
    syncUrlParams();
  });

  el.filterText.addEventListener('input', () => {
    ui.filterText = el.filterText.value;
    refreshWeekGrid();
  });

  el.cardFilterText.addEventListener('input', () => {
    ui.filterText = el.cardFilterText.value;
    refreshWeekCards();
  });

  el.btnExport.addEventListener('click', () => exportCurrentViewPng());

  el.btnBackup.addEventListener('click', () => downloadBackup());
  el.restoreFile.addEventListener('change', (e) => restoreBackup(e.target.files?.[0]));
  el.btnReset.addEventListener('click', () => resetAll());

  el.btnManageMembers.addEventListener('click', () => {
    if (!isAdmin()) return toast('ê´€ë¦¬ì ëª¨ë“œì—ì„œë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
    openModal('modalMembers');
    renderMembersList();
  });

  el.btnManagePlaces.addEventListener('click', () => {
    if (!isAdmin()) return toast('ê´€ë¦¬ì ëª¨ë“œì—ì„œë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
    openModal('modalPlaces');
    renderPlacesList();
  });

  el.btnHowTo.addEventListener('click', () => openModal('modalHowTo'));

  el.btnAddMember.addEventListener('click', () => {
    if (!isAdmin()) return;
    const name = el.newMemberName.value.trim();
    if (!name) return toast('ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.');
    const color = el.newMemberColor.value || '#60a5fa';
    state.members.push({ id: cryptoId(), name, color, active: true });
    persist();
    el.newMemberName.value = '';
    toast('íŒ€ì›ì„ ì¶”ê°€í–ˆìŠµë‹ˆë‹¤. (ê³µìš©DB ì €ì¥ë¨)');
    hydrateSelectors();
    refreshAll();
    renderMembersList();
  });

  el.btnAddPlace.addEventListener('click', () => {
    if (!isAdmin()) return;
    const name = el.newPlaceName.value.trim();
    if (!name) return toast('ì¥ì†Œëª…ì„ ì…ë ¥í•˜ì„¸ìš”.');
    const category = el.newPlaceCat.value;
    state.places.push({ id: cryptoId(), name, category });
    persist();
    el.newPlaceName.value = '';
    toast('ì¥ì†Œë¥¼ ì¶”ê°€í–ˆìŠµë‹ˆë‹¤. (ê³µìš©DB ì €ì¥ë¨)');
    hydrateSelectors();
    refreshAll();
    renderPlacesList();
  });

  el.btnSaveCell.addEventListener('click', () => saveCellAssignments());
  el.btnClearCell.addEventListener('click', () => clearCellAssignments());

  // FAB
  el.fabMain.addEventListener('click', () => {
    el.fab.classList.toggle('open');
  });
  document.addEventListener('click', (e) => {
    if (!el.fab.contains(e.target) && el.fab.classList.contains('open')) el.fab.classList.remove('open');
  });

  el.fabEdit.addEventListener('click', () => { el.fab.classList.remove('open'); openModal('modalAdmin'); });
  el.fabNewWeek.addEventListener('click', () => { el.fab.classList.remove('open'); createNextWeek(); });
  el.fabPng.addEventListener('click', () => { el.fab.classList.remove('open'); exportCurrentViewPng(); });
  el.fabBackup.addEventListener('click', () => { el.fab.classList.remove('open'); downloadBackup(); });
  el.fabSettings.addEventListener('click', () => {
    el.fab.classList.remove('open');
    if (!isAdmin()) return toast('ê´€ë¦¬ì ëª¨ë“œì—ì„œë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
    openModal('modalMembers');
    renderMembersList();
  });

  // ---------- Functions ----------
  function isAdmin(){
    return localStorage.getItem(ADMIN_KEY) === '1';
  }

  function updateRoleUI(){
    const admin = isAdmin();
    el.roleBadge.textContent = admin ? 'ê´€ë¦¬ì(í¸ì§‘ ê°€ëŠ¥)' : 'ë³´ê¸° ì „ìš©';
    el.roleBadge.style.borderColor = admin ? 'rgba(34,197,94,.55)' : 'rgba(255,255,255,.18)';
    el.roleBadge.style.background = admin ? 'rgba(34,197,94,.10)' : 'rgba(255,255,255,.05)';

    el.adminStatus.textContent = admin ? 'ê´€ë¦¬ì(í¸ì§‘ ê°€ëŠ¥)' : 'ë³´ê¸° ì „ìš©';
    el.adminStatus.style.color = admin ? 'var(--ok)' : 'var(--text)';

    el.btnNewWeek.disabled = !admin;
    el.btnNewWeek.style.opacity = admin ? '1' : '.55';
    el.btnNewWeek.title = admin ? '' : 'ê´€ë¦¬ì ëª¨ë“œì—ì„œë§Œ ê°€ëŠ¥';
  }

  function setView(view){
    ui.view = view;
    el.tabs.forEach(t => t.setAttribute('aria-selected', String(t.dataset.view === view)));
    el.viewWeek.classList.toggle('active', view === 'week');
    el.viewWeekCards.classList.toggle('active', view === 'weekCards');
    el.viewPerson.classList.toggle('active', view === 'person');
    el.viewPlace.classList.toggle('active', view === 'place');
    el.viewMonth.classList.toggle('active', view === 'month');

    // mobile default: ì¹´ë“œ ë·°
    if (window.matchMedia && window.matchMedia('(max-width: 720px)').matches && view === 'week'){
      ui.view = 'weekCards';
      el.tabs.forEach(t => t.setAttribute('aria-selected', String(t.dataset.view === ui.view)));
      el.viewWeek.classList.remove('active');
      el.viewWeekCards.classList.add('active');
    }

    refreshAll();
    syncUrlParams();
  }

  function hydrateSelectors(){
    // weeks
    el.weekSelect.innerHTML = '';
    el.weekSelectCards.innerHTML = '';
    el.personWeekSelect.innerHTML = '';
    el.placeWeekSelect.innerHTML = '';
    getWeeksSorted().forEach(w => {
      const opt = new Option(weekLabel(w), w.id);
      el.weekSelect.add(opt.cloneNode(true));
      el.weekSelectCards.add(opt.cloneNode(true));
      el.personWeekSelect.add(opt.cloneNode(true));
      el.placeWeekSelect.add(opt.cloneNode(true));
    });

    // persons (active first)
    el.personSelect.innerHTML = '';
    getMembersSorted().forEach(m => {
      const suffix = m.active ? '' : ' (ë¹„í™œì„±)';
      el.personSelect.add(new Option(m.name + suffix, m.id));
    });

    // places
    el.placeSelect.innerHTML = '';
    getPlacesSorted().forEach(p => {
      el.placeSelect.add(new Option(placeLabel(p), p.id));
    });

    // ensure defaults
    if (!ui.weekId || !state.weeks.some(w => w.id === ui.weekId)) ui.weekId = state.weeks[0]?.id;
    if (!ui.personId || !state.members.some(m => m.id === ui.personId)) ui.personId = state.members[0]?.id;
    if (!ui.placeId || !state.places.some(p => p.id === ui.placeId)) ui.placeId = state.places[0]?.id;

    el.weekSelect.value = ui.weekId;
    el.weekSelectCards.value = ui.weekId;
    el.personWeekSelect.value = ui.weekId;
    el.placeWeekSelect.value = ui.weekId;
    el.personSelect.value = ui.personId;
    el.placeSelect.value = ui.placeId;

    // month input
    if (!ui.month){
      const now = new Date();
      ui.month = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
    }
    el.monthSelect.value = ui.month;
  }

  function refreshAll(){
    ensureWeekExists(ui.weekId);

    // set header
    const w = state.weeks.find(x => x.id === ui.weekId);
    if (w){
      el.weekTitle.textContent = viewTitle();
      el.weekMeta.textContent = `${formatDateKr(new Date(w.startDate))} ~ ${formatDateKr(addDays(new Date(w.startDate), 6))}`;

      el.weekSelect.value = w.id;
      el.personWeekSelect.value = w.id;
      el.placeWeekSelect.value = w.id;
    }

    // tags
    renderMemberTags();

    // views
    refreshWeekGrid();
    refreshWeekCards();
    refreshPersonView();
    refreshPlaceView();
    refreshMonthView();

    // consecutive warnings
    computeConsecutiveWarningsForWeek(ui.weekId);
    // Re-render week grid/cards to show warnings
    refreshWeekGrid();
    refreshWeekCards();
  }

  function viewTitle(){
    if (ui.view === 'week') return 'ì£¼ê°„ ìŠ¤ì¼€ì¤„(í‘œ)';
    if (ui.view === 'weekCards') return 'ì£¼ê°„ ìŠ¤ì¼€ì¤„(ì¹´ë“œ)';
    if (ui.view === 'person') return 'ê°œì¸ë³„ ìŠ¤ì¼€ì¤„';
    if (ui.view === 'place') return 'ì¥ì†Œë³„ ìŠ¤ì¼€ì¤„';
    if (ui.view === 'month') return 'ì›”ê°„ ë‹¬ë ¥';
    return 'ê·¼ë¬´ ìŠ¤ì¼€ì¤„';
  }

  function refreshWeekGrid(){
    const week = state.weeks.find(w => w.id === ui.weekId);
    if (!week) return;

    const dates = getWeekDateKeys(week.startDate);
    const filter = ui.filterText.trim().toLowerCase();

    // Filter places by text
    const places = getPlacesSorted().filter(p => {
      if (!filter) return true;
      if (p.name.toLowerCase().includes(filter)) return true;
      // also filter by member name: if any cell contains that member
      const memberHit = state.members.some(m => m.name.toLowerCase().includes(filter));
      if (!memberHit) return false;
      const targetMemberNames = state.members.filter(m => m.name.toLowerCase().includes(filter)).map(m => m.name);
      const row = week.assignments[p.id] || {};
      return dates.some(dk => {
        const list = row[dk] || [];
        return list.some(mid => {
          const mm = findMember(mid);
          const nm = mm?.name || mid;
          return targetMemberNames.includes(nm);
        });
      });
    });

    const table = document.createElement('table');
    const thead = document.createElement('thead');
    const trh = document.createElement('tr');

    const th0 = document.createElement('th');
    th0.className = 'placeCell';
    th0.textContent = 'ì¥ì†Œ';
    trh.appendChild(th0);

    dates.forEach(dk => {
      const d = parseDateKey(dk);
      const th = document.createElement('th');
      th.className = 'dayHead';
      const dow = d.getDay();
      if (dow === 6) th.classList.add('isSat');
      if (dow === 0) th.classList.add('isSun');
      const hname = holidayName(dk);
      if (hname) th.classList.add('isHoliday');
      const dowLabel = (hname ? `<span class="dow holidayText">${DAY_NAMES[dow]} Â· ${escapeHtml(hname)}</span>` : `<span class="dow">${DAY_NAMES[dow]}</span>`);
      const dateClass = hname ? 'date holidayText' : 'date';
      th.innerHTML = `<span class="${dateClass}">${d.getMonth()+1}/${d.getDate()}</span>${dowLabel}`;
      trh.appendChild(th);
    });

    thead.appendChild(trh);
    table.appendChild(thead);

    const tbody = document.createElement('tbody');

    places.forEach(p => {
      const tr = document.createElement('tr');

      const tdPlace = document.createElement('td');
      tdPlace.className = `placeCell placeTint ${p.category}`;
      tdPlace.innerHTML = `<div class="placeName">${escapeHtml(p.name)}</div><div class="placeMeta">${categoryLabel(p.category)}</div>`;
      tr.appendChild(tdPlace);

      dates.forEach(dk => {
        const td = document.createElement('td');
        const cell = document.createElement('div');
        cell.className = 'cell';

        const warnClass = getWarnClass(week, p.id, dk);
        if (warnClass) cell.classList.add(warnClass);

        cell.setAttribute('data-week', week.id);
        cell.setAttribute('data-place', p.id);
        cell.setAttribute('data-date', dk);

        const admin = isAdmin();
        cell.setAttribute('aria-disabled', String(!admin));

        const assigned = (week.assignments[p.id]?.[dk] || []).slice();

        cell.addEventListener('click', () => {
          if (!isAdmin()) return toast('ë³´ê¸° ì „ìš©ì…ë‹ˆë‹¤. ê´€ë¦¬ì ëª¨ë“œì—ì„œë§Œ í¸ì§‘í•  ìˆ˜ ìˆì–´ìš”.');
          openCellEditor(week.id, p.id, dk);
        });

        // drag drop
        cell.addEventListener('dragover', (e) => {
          if (!isAdmin()) return;
          e.preventDefault();
        });
        cell.addEventListener('drop', (e) => {
          if (!isAdmin()) return;
          e.preventDefault();
          const memberId = e.dataTransfer.getData('text/memberId');
          if (!memberId) return;
          addMemberToCell(week.id, p.id, dk, memberId);
        });

        const header = document.createElement('div');
        header.className = 'cellHeader';
        header.innerHTML = `<span class="hint">${assigned.length ? assigned.length+'ëª…' : 'ë¹ˆì¹¸'}</span>`;
        cell.appendChild(header);

        const tags = document.createElement('div');
        tags.className = 'tags';
        assigned.forEach(mid => {
          const member = findMember(mid);
          const name = member?.name || mid;
          const color = member?.color || '#cbd5e1';
          tags.appendChild(renderTag(name, color, member?.active === false));
        });
        cell.appendChild(tags);

        if (isAdmin()){
          const hint = document.createElement('div');
          hint.className = 'dropHint';
          hint.textContent = 'ë“œë˜ê·¸ë¡œ ì¶”ê°€ Â· í´ë¦­ìœ¼ë¡œ ì„ íƒ';
          cell.appendChild(hint);
        }

        td.appendChild(cell);
        tr.appendChild(td);
      });

      tbody.appendChild(tr);
    });

    table.appendChild(tbody);
    el.weekGrid.innerHTML = '';
    el.weekGrid.appendChild(table);
  }

  function refreshWeekCards(){
    // ì¹´ë“œí˜• ì£¼ê°„ ë·°(ëª¨ë°”ì¼ ìµœì í™”)
    if (ui.view !== 'weekCards') return;

    const week = state.weeks.find(w => w.id === ui.weekId);
    if (!week) return;

    // keep selectors in sync
    el.weekSelectCards.value = week.id;
    el.cardFilterText.value = ui.filterText || '';

    const dates = getWeekDateKeys(week.startDate);
    const filter = (ui.filterText || '').trim().toLowerCase();

    const activePlaces = getPlacesSorted().filter(p => p.active !== false);
    const activeMembers = getMembersSorted(true);

    // Build per day cards
    el.weekCards.innerHTML = '';

    dates.forEach(dk => {
      const d = parseDateKey(dk);
      const dow = DAY_NAMES[d.getDay()];
      const hname = holidayName(dk);

      // Build items (place -> members)
      const rows = [];
      activePlaces.forEach(p => {
        const arr = week.assignments?.[p.id]?.[dk] || [];
        if (!arr.length) return;

        const memberTags = arr.map(mid => {
          const m = findMember(mid);
          const name = m?.name || mid;
          const color = m?.color || '#94a3b8';
          return { id: mid, name, color };
        });

        rows.push({ place: p, members: memberTags });
      });

      // Apply filter (by place or member)
      const filteredRows = !filter ? rows : rows.filter(r => {
        if (r.place.name.toLowerCase().includes(filter)) return true;
        return r.members.some(m => m.name.toLowerCase().includes(filter));
      });

      // Card wrapper
      const card = document.createElement('div');
      card.className = 'card';
      card.style.padding = '14px';

      const head = document.createElement('div');
      head.style.display = 'flex';
      head.style.justifyContent = 'space-between';
      head.style.alignItems = 'baseline';
      head.style.gap = '10px';

      const left = document.createElement('div');
      left.innerHTML = `
        <div style="font-weight:1000; font-size:16px;" class="${hname ? 'holidayText' : ''}">ğŸ“… ${d.getMonth()+1}/${d.getDate()} (${dow})</div>
        ${hname ? `<div class="holidayBadge">${escapeHtml(hname)}</div>` : ''}
      `;

      const right = document.createElement('div');
      right.className = 'hint';
      right.textContent = filteredRows.length ? `${filteredRows.length}ê³³ ë°°ì •` : 'ë°°ì • ì—†ìŒ';

      head.appendChild(left);
      head.appendChild(right);
      card.appendChild(head);

      // Body
      const body = document.createElement('div');
      body.style.marginTop = '12px';
      body.style.display = 'flex';
      body.style.flexDirection = 'column';
      body.style.gap = '10px';

      if (!filteredRows.length){
        const empty = document.createElement('div');
        empty.className = 'hint';
        empty.textContent = 'ì´ ë‚ ì§œì—ëŠ” ë°°ì •ì´ ì—†ìŠµë‹ˆë‹¤.';
        body.appendChild(empty);
      } else {
        filteredRows.forEach(r => {
          const box = document.createElement('div');
          box.style.border = '1px solid rgba(17,24,39,.10)';
          box.style.borderRadius = '14px';
          box.style.background = 'rgba(255,255,255,.92)';
          box.style.padding = '12px';

          const top = document.createElement('div');
          top.style.display = 'flex';
          top.style.justifyContent = 'space-between';
          top.style.alignItems = 'center';
          top.style.gap = '10px';

          const placeName = document.createElement('div');
          placeName.style.fontWeight = '1000';
          placeName.textContent = r.place.name;

          const cat = document.createElement('div');
          cat.className = 'badge';
          cat.textContent = categoryLabel(r.place.category);

          top.appendChild(placeName);
          top.appendChild(cat);
          box.appendChild(top);

          const tags = document.createElement('div');
          tags.className = 'tags';
          tags.style.marginTop = '10px';

          r.members.forEach(m => {
            tags.appendChild(renderTag(m.name, m.color, false));
          });

          box.appendChild(tags);

          if (isAdmin()){
            const btn = document.createElement('button');
            btn.className = 'btn';
            btn.style.marginTop = '10px';
            btn.textContent = 'âœï¸ ì´ ì¥ì†Œ í¸ì§‘';
            btn.addEventListener('click', () => {
              openCellEditor(week.id, r.place.id, dk);
            });
            box.appendChild(btn);
          }

          body.appendChild(box);
        });
      }

      card.appendChild(body);
      el.weekCards.appendChild(card);
    });
  }

  function refreshPersonView(){
    if (ui.view !== 'person') return;

    const week = state.weeks.find(w => w.id === ui.weekId);
    if (!week) return;

    const person = state.members.find(m => m.id === ui.personId);
    if (!person) return;

    const dates = getWeekDateKeys(week.startDate);
    const items = [];

    for (const p of getPlacesSorted()){
      for (const dk of dates){
        const arr = week.assignments[p.id]?.[dk] || [];
        if (arr.includes(person.id)){
          items.push({ dateKey: dk, place: p });
        }
      }
    }

    items.sort((a,b) => a.dateKey.localeCompare(b.dateKey));

    el.personCards.innerHTML = '';

    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `<h3>ğŸ‘¤ ${escapeHtml(person.name)}ë‹˜ì˜ ìŠ¤ì¼€ì¤„</h3>`;

    const list = document.createElement('div');
    list.className = 'list';

    if (!items.length){
      const empty = document.createElement('div');
      empty.className = 'hint';
      empty.textContent = 'ì´ë²ˆ ì£¼ ë°°ì •ëœ ê·¼ë¬´ê°€ ì—†ìŠµë‹ˆë‹¤.';
      list.appendChild(empty);
    } else {
      for (const it of items){
        const d = parseDateKey(it.dateKey);
        const dow = DAY_NAMES[d.getDay()];
        const li = document.createElement('div');
        li.className = 'item';
        li.innerHTML = `<div class="left"><div class="title">ğŸ“… ${d.getMonth()+1}/${d.getDate()} (${dow})</div><div class="sub">${escapeHtml(it.place.name)} Â· ${categoryLabel(it.place.category)}</div></div>`;
        list.appendChild(li);
      }
    }

    card.appendChild(list);

    const kpi = document.createElement('div');
    kpi.className = 'kpi';
    kpi.innerHTML = `<div class="box"><div class="num">${items.length}</div><div class="lbl">ì´ë²ˆ ì£¼ ê·¼ë¬´(ë°°ì •) ê±´ìˆ˜</div></div>`;

    card.appendChild(kpi);

    el.personCards.appendChild(card);

    // also add a mini weekly grid for that person
    const mini = document.createElement('div');
    mini.className = 'card';
    mini.innerHTML = `<h3>ì£¼ê°„ ë³´ê¸°</h3><div class="hint">ì¥ì†Œë³„ ì „ì²´ì—ì„œ, ${escapeHtml(person.name)}ë§Œ í‘œì‹œí•©ë‹ˆë‹¤.</div>`;
    const miniTable = renderMiniWeekForPerson(week, person.id);
    mini.appendChild(miniTable);
    el.personCards.appendChild(mini);
  }

  function refreshPlaceView(){
    if (ui.view !== 'place') return;

    const week = state.weeks.find(w => w.id === ui.weekId);
    if (!week) return;

    const place = state.places.find(p => p.id === ui.placeId);
    if (!place) return;

    const dates = getWeekDateKeys(week.startDate);
    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `<h3>ğŸ¢ ${escapeHtml(place.name)}</h3><div class="hint">${categoryLabel(place.category)} Â· ì£¼ê°„ ë°°ì •</div>`;

    const list = document.createElement('div');
    list.className = 'list';

    dates.forEach(dk => {
      const d = parseDateKey(dk);
      const dow = DAY_NAMES[d.getDay()];
      const arr = week.assignments[place.id]?.[dk] || [];
      const item = document.createElement('div');
      item.className = 'item';
      item.innerHTML = `<div class="left"><div class="title">ğŸ“… ${d.getMonth()+1}/${d.getDate()} (${dow})</div><div class="sub">${arr.length ? arr.map(mid => escapeHtml(findMember(mid)?.name || mid)).join(', ') : 'ë°°ì • ì—†ìŒ'}</div></div>`;
      list.appendChild(item);
    });

    card.appendChild(list);

    el.placeCards.innerHTML = '';
    el.placeCards.appendChild(card);
  }

  function refreshMonthView(){
    if (ui.view !== 'month') return;

    el.monthSelect.onchange = () => {
      ui.month = el.monthSelect.value;
      refreshMonthView();
      syncUrlParams();
    };

    el.btnMonthToday.onclick = () => {
      const now = new Date();
      ui.month = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
      el.monthSelect.value = ui.month;
      refreshMonthView();
    };

    el.btnMonthCompact.onclick = () => {
      ui.monthCompact = !ui.monthCompact;
      toast(ui.monthCompact ? 'ë‹¬ë ¥: ê°„ë‹¨íˆ' : 'ë‹¬ë ¥: ìì„¸íˆ');
      refreshMonthView();
    };

    const [yy, mm] = ui.month.split('-').map(Number);
    const first = new Date(yy, mm-1, 1);
    const last = new Date(yy, mm, 0);
    const startDow = first.getDay();

    // Build a lookup from all weeks assignments for that month
    const lookup = buildMonthLookup(yy, mm-1);

    const wrap = document.createElement('div');
    wrap.innerHTML = `<h3 style="margin:0 0 10px;">ğŸ“† ${yy}ë…„ ${mm}ì›”</h3><div class="hint" style="margin-bottom:12px;">ì¹¸ì„ í´ë¦­í•˜ë©´ í•´ë‹¹ ì£¼ì°¨ë¡œ ì´ë™í•©ë‹ˆë‹¤(ë³´ê¸° ì „í™˜ì€ ìœ ì§€).</div>`;

    const grid = document.createElement('div');
    grid.style.display = 'grid';
    grid.style.gridTemplateColumns = 'repeat(7, 1fr)';
    grid.style.gap = '8px';

    // day headers
    DAY_NAMES.forEach((n, i) => {
      const h = document.createElement('div');
      h.style.padding = '8px 10px';
      h.style.border = '1px solid rgba(17,24,39,.12)';
      h.style.borderRadius = '12px';
      h.style.background = 'rgba(255,255,255,.96)';
      h.style.fontWeight = '1000';
      h.style.fontSize = '12px';
      h.style.textAlign = 'center';
      if (i === 6) h.style.background = 'rgba(255,237,213,.55)';
      if (i === 0) { h.style.background = 'rgba(255,228,230,.55)'; h.style.color = 'var(--holiday)'; }
      h.textContent = n;
      grid.appendChild(h);
    });

    // empty cells
    for (let i=0;i<startDow;i++){
      grid.appendChild(blankCalCell());
    }

    for (let day=1; day<=last.getDate(); day++){
      const d = new Date(yy, mm-1, day);
      const dk = toDateKey(d);
      const cell = document.createElement('div');
      cell.style.border = '1px solid rgba(17,24,39,.12)';
      cell.style.borderRadius = '14px';
      cell.style.background = 'rgba(255,255,255,.98)';
      cell.style.padding = '10px 10px';
      cell.style.minHeight = ui.monthCompact ? '78px' : '120px';
      cell.style.cursor = 'pointer';

      if (d.getDay() === 6) cell.style.background = 'rgba(255,237,213,.45)';
      if (d.getDay() === 0) cell.style.background = 'rgba(255,228,230,.45)';
      if (isHoliday(dk)) cell.style.background = 'rgba(254,226,226,.55)';

      const info = lookup[dk];
      const count = info?.count || 0;
      const top = document.createElement('div');
      top.style.display = 'flex';
      top.style.justifyContent = 'space-between';
      top.style.alignItems = 'baseline';
      const hname = holidayName(dk);
      top.innerHTML = `<div style="font-weight:1000;" class="${hname ? 'holidayText' : ''}">${day}</div><div class="hint ${hname ? 'holidayText' : ''}">${hname ? hname : (count ? count+'ê±´' : '')}</div>`;
      cell.appendChild(top);

      if (!ui.monthCompact && info){
        const mini = document.createElement('div');
        mini.style.marginTop = '8px';
        mini.style.display = 'flex';
        mini.style.flexDirection = 'column';
        mini.style.gap = '6px';
        const lines = info.lines.slice(0, 3);
        lines.forEach(line => {
          const div = document.createElement('div');
          div.className = 'hint';
          div.textContent = line;
          mini.appendChild(div);
        });
        if (info.lines.length > 3){
          const more = document.createElement('div');
          more.className = 'hint';
          more.textContent = `+${info.lines.length-3}ê±´ ë”...`;
          mini.appendChild(more);
        }
        cell.appendChild(mini);
      }

      cell.addEventListener('click', () => {
        const weekId = findWeekIdForDate(d);
        if (weekId){
          ui.weekId = weekId;
          hydrateSelectors();
          setView('weekCards');
          el.weekSelect.value = weekId;
          refreshAll();
          toast('í•´ë‹¹ ì£¼ì°¨ë¡œ ì´ë™í–ˆìŠµë‹ˆë‹¤.');
        }
      });

      grid.appendChild(cell);
    }

    // fill to end row
    const total = 7 + startDow + last.getDate(); // including headers row
    const remainder = total % 7;
    const toAdd = remainder === 0 ? 0 : (7 - remainder);
    for (let i=0;i<toAdd;i++) grid.appendChild(blankCalCell());

    el.monthCalendar.innerHTML = '';
    wrap.appendChild(grid);
    el.monthCalendar.appendChild(wrap);
  }

  function blankCalCell(){
    const cell = document.createElement('div');
    cell.style.border = '1px dashed rgba(17,24,39,.12)';
    cell.style.borderRadius = '14px';
    cell.style.background = 'rgba(255,255,255,.85)';
    cell.style.minHeight = ui.monthCompact ? '78px' : '120px';
    return cell;
  }

  function renderMemberTags(){
    const admin = isAdmin();
    el.memberTags.innerHTML = '';
    const members = getMembersSorted().filter(m => m.active);
    members.forEach(m => {
      const t = renderTag(m.name, m.color, false);
      t.setAttribute('draggable', admin ? 'true' : 'false');
      t.title = admin ? 'ë“œë˜ê·¸í•´ì„œ ë°°ì¹˜' : 'ë³´ê¸° ì „ìš©';
      t.addEventListener('dragstart', (e) => {
        if (!isAdmin()) return;
        t.classList.add('dragging');
        e.dataTransfer.setData('text/memberId', m.id);
        e.dataTransfer.effectAllowed = 'copy';
      });
      t.addEventListener('dragend', () => t.classList.remove('dragging'));
      el.memberTags.appendChild(t);
    });
  }

  function renderTag(name, color, inactive){
    const tag = document.createElement('div');
    tag.className = 'tag';
    tag.innerHTML = `<span class="dot"></span><span class="name"></span>`;
    tag.querySelector('.dot').style.background = color;
    tag.querySelector('.name').textContent = name + (inactive ? ' (ë¹„)' : '');
    return tag;
  }

  function openCellEditor(weekId, placeId, dateKey){
    ui.editingCell = { weekId, placeId, dateKey };
    const week = state.weeks.find(w => w.id === weekId);
    const place = state.places.find(p => p.id === placeId);
    if (!week || !place) return;

    const d = parseDateKey(dateKey);
    const dow = DAY_NAMES[d.getDay()];
    el.cellMeta.innerHTML = `<b>${escapeHtml(place.name)}</b> Â· ${formatDateKr(d)} (${dow})`;

    const assigned = new Set(week.assignments[placeId]?.[dateKey] || []);

    el.cellChecklist.innerHTML = '';
    getMembersSorted().forEach(m => {
      const div = document.createElement('div');
      div.className = 'check';
      div.innerHTML = `
        <label>
          <input type="checkbox" data-mid="${m.id}" ${assigned.has(m.id) ? 'checked' : ''} ${m.active ? '' : 'disabled'} />
          <span>${escapeHtml(m.name)}${m.active ? '' : ' (ë¹„í™œì„±)'}</span>
        </label>
        <span class="badge" style="border-color: ${m.color}55;">ìƒ‰</span>
      `;
      el.cellChecklist.appendChild(div);
    });

    openModal('modalCell');
  }

  function saveCellAssignments(){
    if (!isAdmin()) return;
    const c = ui.editingCell;
    if (!c) return;
    const week = state.weeks.find(w => w.id === c.weekId);
    if (!week) return;

    const mids = Array.from(el.cellChecklist.querySelectorAll('input[type="checkbox"]'))
      .filter(cb => cb.checked)
      .map(cb => cb.dataset.mid);

    week.assignments[c.placeId] ||= {};
    week.assignments[c.placeId][c.dateKey] = mids;

    (async () => {
      try{
        await persist();
        toast('ì €ì¥í–ˆìŠµë‹ˆë‹¤. (ê³µìš©DB ì €ì¥ë¨)');
      }catch{
        // persist() ë‚´ë¶€ì—ì„œ ì‹¤íŒ¨ í† ìŠ¤íŠ¸ë¥¼ ë„ì›€
        toast('ì €ì¥í–ˆìŠµë‹ˆë‹¤. (ë¡œì»¬ ì €ì¥ë§Œ ë¨)');
      }finally{
        computeConsecutiveWarningsForWeek(week.id);
        refreshWeekGrid();
        refreshPersonView();
        refreshPlaceView();
        closeModal('modalCell');
      }
    })();
  }

  function clearCellAssignments(){
    if (!isAdmin()) return;
    const c = ui.editingCell;
    if (!c) return;
    const week = state.weeks.find(w => w.id === c.weekId);
    if (!week) return;

    week.assignments[c.placeId] ||= {};
    week.assignments[c.placeId][c.dateKey] = [];

    (async () => {
      try{
        await persist();
        toast('ë¹„ì› ìŠµë‹ˆë‹¤. (ê³µìš©DB ì €ì¥ë¨)');
      }catch{
        toast('ë¹„ì› ìŠµë‹ˆë‹¤. (ë¡œì»¬ ì €ì¥ë§Œ ë¨)');
      }finally{
        computeConsecutiveWarningsForWeek(week.id);
        refreshWeekGrid();
        refreshPersonView();
        refreshPlaceView();
        closeModal('modalCell');
      }
    })();
  }

  function addMemberToCell(weekId, placeId, dateKey, memberId){
    if (!isAdmin()) return;
    const week = state.weeks.find(w => w.id === weekId);
    if (!week) return;

    week.assignments[placeId] ||= {};
    const arr = week.assignments[placeId][dateKey] ||= [];
    if (!arr.includes(memberId)) arr.push(memberId);

    persist();
    computeConsecutiveWarningsForWeek(week.id);
    refreshWeekGrid();
    refreshPersonView();
    refreshPlaceView();
  }

  function computeConsecutiveWarningsForWeek(weekId){
    const week = state.weeks.find(w => w.id === weekId);
    if (!week) return;

    // Reset
    week.warnings = {};

    const dates = getWeekDateKeys(week.startDate);
    // For each member, check for same place consecutive days.
    const memberIds = state.members.map(m => m.id);

    for (const mid of memberIds){
      // Build array per day of placeIds assigned
      const perDay = dates.map(dk => {
        const assignedPlaces = [];
        for (const p of state.places){
          const arr = week.assignments[p.id]?.[dk] || [];
          if (arr.includes(mid)) assignedPlaces.push(p.id);
        }
        return { dk, places: assignedPlaces };
      });

      // If a member is assigned to multiple places in same day, we won't apply consecutive same-place warning unless intersection on next day.
      for (let i=0;i<perDay.length;i++){
        for (const pid of perDay[i].places){
          let streak = 1;
          for (let j=i+1;j<perDay.length;j++){
            if (perDay[j].places.includes(pid)) streak++;
            else break;
          }
          if (streak >= 2){
            for (let k=0;k<streak;k++){
              const dk = perDay[i+k].dk;
              week.warnings[pid] ||= {};
              const level = streak >= 3 ? 3 : 2;
              const prev = week.warnings[pid][dk] || 0;
              week.warnings[pid][dk] = Math.max(prev, level);
            }
          }
        }
      }
    }

    persist();
  }

  function getWarnClass(week, placeId, dateKey){
    const lvl = week.warnings?.[placeId]?.[dateKey] || 0;
    if (lvl >= 3) return 'warn3';
    if (lvl === 2) return 'warn2';
    return '';
  }

  function renderMiniWeekForPerson(week, memberId){
    const dates = getWeekDateKeys(week.startDate);
    const table = document.createElement('table');
    table.style.minWidth = '700px';

    const thead = document.createElement('thead');
    const trh = document.createElement('tr');
    const th0 = document.createElement('th');
    th0.textContent = 'ì¥ì†Œ';
    th0.className = 'placeCell';
    trh.appendChild(th0);

    dates.forEach(dk => {
      const d = parseDateKey(dk);
      const th = document.createElement('th');
      const dow = d.getDay();
      if (dow === 6) th.classList.add('isSat');
      if (dow === 0) th.classList.add('isSun');
      const hname = holidayName(dk);
      if (hname) th.classList.add('isHoliday');
      const dowLabel = (hname ? `<span class="dow holidayText">${DAY_NAMES[dow]} Â· ${escapeHtml(hname)}</span>` : `<span class="dow">${DAY_NAMES[dow]}</span>`);
      const dateClass = hname ? 'date holidayText' : 'date';
      th.innerHTML = `<span class="${dateClass}">${d.getMonth()+1}/${d.getDate()}</span>${dowLabel}`;
      trh.appendChild(th);
    });

    thead.appendChild(trh);
    table.appendChild(thead);

    const tbody = document.createElement('tbody');
    getPlacesSorted().forEach(p => {
      const tr = document.createElement('tr');
      const tdP = document.createElement('td');
      tdP.className = `placeCell placeTint ${p.category}`;
      tdP.innerHTML = `<div class="placeName">${escapeHtml(p.name)}</div><div class="placeMeta">${categoryLabel(p.category)}</div>`;
      tr.appendChild(tdP);

      dates.forEach(dk => {
        const td = document.createElement('td');
        const cell = document.createElement('div');
        cell.className = 'cell';
        cell.setAttribute('aria-disabled','true');

        const arr = week.assignments[p.id]?.[dk] || [];
        const has = arr.includes(memberId);

        if (has){
          const member = findMember(memberId);
          cell.style.borderStyle = 'solid';
          cell.style.borderColor = member?.color ? member.color + 'aa' : 'rgba(124,58,237,.5)';
          const tags = document.createElement('div');
          tags.className = 'tags';
          tags.appendChild(renderTag(member?.name || 'ë°°ì •', member?.color || '#cbd5e1', false));
          cell.appendChild(tags);
        } else {
          cell.innerHTML = `<div class="hint">-</div>`;
        }

        td.appendChild(cell);
        tr.appendChild(td);
      });

      tbody.appendChild(tr);
    });

    table.appendChild(tbody);
    const wrap = document.createElement('div');
    wrap.className = 'gridWrap';
    wrap.appendChild(table);
    return wrap;
  }

  function renderMembersList(){
    el.membersList.innerHTML = '';
    getMembersSorted(true).forEach(m => {
      const row = document.createElement('div');
      row.className = 'item';
      row.innerHTML = `
        <div class="left">
          <div class="title">${escapeHtml(m.name)}</div>
          <div class="sub">ìƒíƒœ: ${m.active ? 'í™œì„±' : 'ë¹„í™œì„±'} Â· ìƒ‰ìƒ: <span style="color:${m.color}; font-weight:900;">${m.color}</span></div>
        </div>
        <div class="right">
          <button class="btn" data-act="toggle">${m.active ? 'ë¹„í™œì„±' : 'í™œì„±'}</button>
          <button class="btn" data-act="rename">ì´ë¦„ë³€ê²½</button>
          <button class="btn" data-act="color">ìƒ‰ìƒ</button>
          <button class="btn danger" data-act="delete">ì‚­ì œ</button>
        </div>
      `;

      row.querySelector('[data-act="toggle"]').addEventListener('click', () => {
        m.active = !m.active;
        persist();
        hydrateSelectors();
        refreshAll();
        renderMembersList();
        pullFromServer({ force: true }).catch(() => {});
      });

      row.querySelector('[data-act="rename"]').addEventListener('click', () => {
        const name = prompt('ìƒˆ ì´ë¦„', m.name);
        if (!name) return;
        m.name = name.trim();
        persist();
        hydrateSelectors();
        refreshAll();
        renderMembersList();
        pullFromServer({ force: true }).catch(() => {});
      });

      row.querySelector('[data-act="color"]').addEventListener('click', () => {
        const color = prompt('ìƒ‰ìƒ HEX (ì˜ˆ: #60a5fa)', m.color);
        if (!color) return;
        if (!/^#[0-9a-fA-F]{6}$/.test(color.trim())) return toast('í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        m.color = color.trim();
        persist();
        hydrateSelectors();
        refreshAll();
        renderMembersList();
        pullFromServer({ force: true }).catch(() => {});
      });

      row.querySelector('[data-act="delete"]').addEventListener('click', () => {
        if (!confirm(`ì •ë§ ì‚­ì œí• ê¹Œìš”? (ê³¼ê±° ê¸°ë¡ì€ ë‚¨ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤)\n- ${m.name}`)) return;
        state.members = state.members.filter(x => x.id !== m.id);
        persist();
        hydrateSelectors();
        refreshAll();
        renderMembersList();
        pullFromServer({ force: true }).catch(() => {});
      });

      el.membersList.appendChild(row);
    });
  }

  function renderPlacesList(){
    el.placesList.innerHTML = '';
    getPlacesSorted(true).forEach(p => {
      const row = document.createElement('div');
      row.className = 'item';
      row.innerHTML = `
        <div class="left">
          <div class="title">${escapeHtml(p.name)}</div>
          <div class="sub">ë¶„ë¥˜: ${categoryLabel(p.category)}</div>
        </div>
        <div class="right">
          <button class="btn" data-act="cat">ë¶„ë¥˜ë³€ê²½</button>
          <button class="btn" data-act="rename">ì´ë¦„ë³€ê²½</button>
          <button class="btn danger" data-act="delete">ì‚­ì œ</button>
        </div>
      `;

      row.querySelector('[data-act="cat"]').addEventListener('click', () => {
        const cat = prompt('ë¶„ë¥˜ ì…ë ¥: bookstore / mart / other', p.category);
        if (!cat) return;
        if (!['bookstore','mart','other'].includes(cat.trim())) return toast('ë¶„ë¥˜ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        p.category = cat.trim();
        persist();
        hydrateSelectors();
        refreshAll();
        renderPlacesList();
        pullFromServer({ force: true }).catch(() => {});
      });

      row.querySelector('[data-act="rename"]').addEventListener('click', () => {
        const name = prompt('ìƒˆ ì¥ì†Œëª…', p.name);
        if (!name) return;
        p.name = name.trim();
        persist();
        hydrateSelectors();
        refreshAll();
        renderPlacesList();
        pullFromServer({ force: true }).catch(() => {});
      });

      row.querySelector('[data-act="delete"]').addEventListener('click', () => {
        if (!confirm(`ì •ë§ ì‚­ì œí• ê¹Œìš”? (ê³¼ê±° ê¸°ë¡ì€ ë‚¨ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤)\n- ${p.name}`)) return;
        state.places = state.places.filter(x => x.id !== p.id);
        // remove assignments
        state.weeks.forEach(w => { delete w.assignments[p.id]; delete w.warnings?.[p.id]; });
        persist();
        hydrateSelectors();
        refreshAll();
        renderPlacesList();
        pullFromServer({ force: true }).catch(() => {});
      });

      el.placesList.appendChild(row);
    });
  }

  function createNextWeek(){
    if (!isAdmin()) return toast('ê´€ë¦¬ì ëª¨ë“œì—ì„œë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
    const weeks = getWeeksSorted();
    const last = weeks[weeks.length-1];
    const nextStart = addDays(new Date(last.startDate), 7);
    const newWeek = makeWeek(nextStart);
    state.weeks.push(newWeek);
    persist();
    pullFromServer({ force: true }).catch(() => {});
    hydrateSelectors();
    ui.weekId = newWeek.id;
    toast('ë‹¤ìŒ ì£¼ì°¨ë¥¼ ìƒì„±í–ˆìŠµë‹ˆë‹¤. (ê³µìš©DB ì €ì¥ë¨)');
    refreshAll();
    syncUrlParams();
  }

  function jumpWeek(delta){
    const weeks = getWeeksSorted();
    const idx = weeks.findIndex(w => w.id === ui.weekId);
    const nextIdx = Math.min(weeks.length-1, Math.max(0, idx + delta));
    ui.weekId = weeks[nextIdx].id;
    hydrateSelectors();
    refreshAll();
    syncUrlParams();
  }

  function goToTodayWeek(){
    const today = new Date();
    const weekId = findWeekIdForDate(today);
    if (!weekId){
      // create enough weeks to include today
      const weeks = getWeeksSorted();
      let last = weeks[weeks.length-1];
      while (new Date(last.startDate) < startOfWeekMon(today)){
        const ns = addDays(new Date(last.startDate), 7);
        const nw = makeWeek(ns);
        state.weeks.push(nw);
        last = nw;
      }
      persist();
      hydrateSelectors();
      ui.weekId = findWeekIdForDate(today);
    } else {
      ui.weekId = weekId;
    }
    hydrateSelectors();
    refreshAll();
    toast('ì˜¤ëŠ˜ì´ í¬í•¨ëœ ì£¼ì°¨ë¡œ ì´ë™');
  }

  async function exportCurrentViewPng(){
    const area = el.exportAreas[ui.view];
    if (!area) return;

    toast('ì´ë¯¸ì§€ ìƒì„± ì¤‘...');

    // Temporarily add padding for nicer export
    const prevPadding = area.style.padding;
    const prevBg = area.style.background;
    area.style.padding = '14px';
    area.style.background = '#ffffff';

    const canvas = await html2canvas(area, {
      backgroundColor: '#ffffff',
      scale: window.devicePixelRatio > 2 ? 2 : window.devicePixelRatio,
      useCORS: true
    });

    area.style.padding = prevPadding;
    area.style.background = prevBg;

    const a = document.createElement('a');
    const name = `schedule_${ui.view}_${Date.now()}.png`;
    a.download = name;
    a.href = canvas.toDataURL('image/png');
    a.click();

    toast('PNGë¡œ ì €ì¥í–ˆìŠµë‹ˆë‹¤.');
  }

  function downloadBackup(){
    const blob = new Blob([JSON.stringify(state, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `schedule_backup_${new Date().toISOString().slice(0,10)}.json`;
    a.click();
    URL.revokeObjectURL(url);
    toast('ë°±ì—… íŒŒì¼ì„ ë‹¤ìš´ë¡œë“œí–ˆìŠµë‹ˆë‹¤.');
  }

  async function restoreBackup(file){
    if (!file) return;
    try{
      const text = await file.text();
      const data = JSON.parse(text);
      if (!data || !Array.isArray(data.members) || !Array.isArray(data.places) || !Array.isArray(data.weeks)){
        throw new Error('í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
      }
      state = data;
      persist();
      hydrateSelectors();
      refreshAll();
      toast('ë³µì› ì™„ë£Œ');
    }catch(err){
      toast('ë³µì› ì‹¤íŒ¨: ' + err.message);
    } finally {
      el.restoreFile.value = '';
    }
  }

  async function resetAll(){
    if (!confirm('ì •ë§ ì´ˆê¸°í™”í• ê¹Œìš”? ì €ì¥ëœ ëª¨ë“  ë°ì´í„°ê°€ ì‚­ì œë©ë‹ˆë‹¤.')) return;
    state = createDefaultState();
    // ë¡œì»¬ ì´ˆê¸°í™” í›„, ê´€ë¦¬ìë¼ë©´ ê³µìš©DBì—ë„ ë°˜ì˜í• ì§€ í™•ì¸
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    hydrateSelectors();
    refreshAll();

    if (isAdmin()){
      const ok = confirm('ê´€ë¦¬ì ëª¨ë“œì…ë‹ˆë‹¤. ê³µìš©DB(êµ¬ê¸€ì‹œíŠ¸)ë„ ì´ˆê¸°í™”í• ê¹Œìš”?\n(íŒ€ì› ëª¨ë‘ì—ê²Œ ì¦‰ì‹œ ë°˜ì˜ë©ë‹ˆë‹¤)');
      if (ok){
        try{
          await pushToServer();
          toast('ê³µìš©DBê¹Œì§€ ì´ˆê¸°í™” ì™„ë£Œ');
        }catch(e){
          toast('ê³µìš©DB ì´ˆê¸°í™” ì‹¤íŒ¨(ë„¤íŠ¸ì›Œí¬ í™•ì¸)');
        }
      } else {
        toast('ë¡œì»¬ë§Œ ì´ˆê¸°í™”í–ˆìŠµë‹ˆë‹¤.');
      }
    } else {
      toast('ë¡œì»¬ë§Œ ì´ˆê¸°í™”í–ˆìŠµë‹ˆë‹¤.');
    }
  }

  function ensureWeekExists(weekId){
    if (state.weeks.some(w => w.id === weekId)) return;
    if (!state.weeks.length) state.weeks.push(makeWeek(DEFAULT_WEEK_START));
    ui.weekId = state.weeks[0].id;
  }

  function getWeeksSorted(){
    return [...state.weeks].sort((a,b) => new Date(a.startDate) - new Date(b.startDate));
  }

  function getMembersSorted(includeInactive=false){
    const arr = [...state.members];
    arr.sort((a,b) => {
      if (a.active !== b.active) return a.active ? -1 : 1;
      return a.name.localeCompare(b.name, 'ko');
    });
    return includeInactive ? arr : arr.filter(m => m.active);
  }

  function getPlacesSorted(includeInactive=false){
    const order = { bookstore: 1, mart: 2, other: 3 };
    const arr = [...(state.places || [])];
    arr.sort((a,b) => {
      const ca = order[a.category] || 9;
      const cb = order[b.category] || 9;
      if (ca !== cb) return ca - cb;
      return String(a.name||'').localeCompare(String(b.name||''), 'ko');
    });
    return includeInactive ? arr : arr.filter(p => p.active !== false);
  }

  function placeLabel(p){
    const prefix = p.category === 'bookstore' ? 'ğŸ“š' : p.category === 'mart' ? 'ğŸ›’' : 'ğŸ“';
    return `${prefix} ${p.name}`;
  }

  function categoryLabel(cat){
    if (cat === 'bookstore') return 'ì„œì ';
    if (cat === 'mart') return 'ë§ˆíŠ¸';
    return 'ê¸°íƒ€';
  }

  function migrateState(loaded){
    if (!loaded) return null;

    // If old data exists, keep it (do not surprise users). But ensure required fields.
    loaded.version ||= 1;
    loaded.members ||= [];
    loaded.places ||= [];
    loaded.weeks ||= [];

    // Ensure every member/place has id
    loaded.members.forEach(m => { m.id ||= cryptoId(); m.active = (m.active !== false); m.color ||= '#60a5fa'; });
    loaded.places.forEach(p => { p.id ||= cryptoId(); p.category ||= 'bookstore'; });

    // If weeks are empty, start from 2026-01-19
    if (!loaded.weeks.length){
      loaded.weeks.push(makeWeek(DEFAULT_WEEK_START, loaded.places.length ? loaded.places : DEFAULT_PLACES));
    }

    // Ensure warnings exists
    loaded.weeks.forEach(w => { w.warnings ||= {}; w.assignments ||= {}; w.id ||= cryptoId(); });

    return loaded;
  }

  function createDefaultState(){
    // Avoid referencing `state` while it is being initialized.
    const week = makeWeek(DEFAULT_WEEK_START, DEFAULT_PLACES);
    return {
      version: 2,
      members: DEFAULT_MEMBERS,
      places: DEFAULT_PLACES,
      weeks: [week]
    };
  }

  function makeWeek(startDate, placesOverride){
    const sd = startOfWeekMon(startDate);
    const week = {
      id: cryptoId(),
      startDate: toDateKey(sd),
      assignments: {},
      warnings: {}
    };

    // precreate empty assignment structure (optional)
    const dates = getWeekDateKeys(week.startDate);
    const places = Array.isArray(placesOverride)
      ? placesOverride
      : ((typeof state !== 'undefined' && state && Array.isArray(state.places)) ? state.places : DEFAULT_PLACES);

    places.forEach(p => {
      week.assignments[p.id] = {};
      dates.forEach(dk => week.assignments[p.id][dk] = []);
    });

    return week;
  }

  function weekLabel(week){
    // Defensive: avoid NaN labels when data is malformed
    if (!week?.startDate || !/^\d{4}-\d{2}-\d{2}$/.test(String(week.startDate))) {
      return `ì£¼ì°¨(${escapeHtml(String(week?.id || 'unknown'))})`;
    }
    const sd = parseDateKey(week.startDate);
    if (isNaN(sd.getTime())) return `ì£¼ì°¨(${escapeHtml(String(week?.id || 'unknown'))})`;
    const ed = addDays(sd, 6);
    return `${sd.getFullYear()}-${String(sd.getMonth()+1).padStart(2,'0')}-${String(sd.getDate()).padStart(2,'0')} ~ ${String(ed.getMonth()+1).padStart(2,'0')}-${String(ed.getDate()).padStart(2,'0')}`;
  }

  function getWeekDateKeys(startDateKey){
    const sd = parseDateKey(startDateKey);
    const keys = [];
    for (let i=0;i<7;i++) keys.push(toDateKey(addDays(sd,i)));
    return keys;
  }

  function buildMonthLookup(year, monthIndex){
    // returns {dateKey: {count, lines[]}}
    const lookup = {};
    for (const w of state.weeks){
      const sd = parseDateKey(w.startDate);
      const dates = getWeekDateKeys(w.startDate);
      for (const dk of dates){
        const d = parseDateKey(dk);
        if (d.getFullYear() !== year || d.getMonth() !== monthIndex) continue;
        const lines = [];
        let count = 0;
        for (const p of state.places){
          const arr = w.assignments[p.id]?.[dk] || [];
          if (arr.length){
            count += arr.length;
            const names = arr.map(mid => findMember(mid)?.name || mid).join(', ');
            lines.push(`${p.name}: ${names}`);
          }
        }
        if (count){
          lookup[dk] = lookup[dk] || { count: 0, lines: [] };
          lookup[dk].count += count;
          lookup[dk].lines.push(...lines);
        }
      }
    }
    return lookup;
  }

  function findWeekIdForDate(date){
    const dk = toDateKey(date);
    for (const w of state.weeks){
      const dates = getWeekDateKeys(w.startDate);
      if (dates.includes(dk)) return w.id;
    }
    return null;
  }

  function startOfWeekMon(date){
    const d = new Date(date);
    d.setHours(0,0,0,0);
    const day = d.getDay();
    // Monday=1, Sunday=0
    const diff = (day === 0 ? -6 : 1 - day);
    d.setDate(d.getDate() + diff);
    return d;
  }

  function addDays(date, days){
    const d = new Date(date);
    d.setDate(d.getDate() + days);
    return d;
  }

  function toDateKey(date){
    const d = new Date(date);
    d.setHours(0,0,0,0);
    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
  }

  function parseDateKey(key){
    const [y,m,d] = key.split('-').map(Number);
    return new Date(y, m-1, d);
  }

  function formatDateKr(date){
    const d = new Date(date);
    return `${d.getFullYear()}ë…„ ${d.getMonth()+1}ì›” ${d.getDate()}ì¼`;
  }

  function findMember(id){
    return state.members.find(m => m.id === id) || null;
  }

  async function persist(options = { push: true }){
    // Always save locally
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));

    // Push to server only if admin (team lead) and allowed
    if (options.push && isAdmin()){
      toast('ê³µìš©DB ì €ì¥ ì¤‘...');
      try{
        await pushToServer();
        toast('ê³µìš©DB ì €ì¥ ì™„ë£Œ');
      }catch{
        // pushToServer already toasted error
      }
    }
  }

  function loadState(){
    // NOTE: must not touch `state` variable here.
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return null;
      return JSON.parse(raw);
    }catch{ return null; }
  }

  function stableHash(obj){
    // simple stable hash (not crypto) for change detection
    const s = JSON.stringify(obj);
    let h = 0;
    for (let i=0;i<s.length;i++) h = ((h<<5)-h) + s.charCodeAt(i) | 0;
    return String(h);
  }

  function startPolling(){
    if (pollTimer) clearInterval(pollTimer);
    pollTimer = setInterval(() => {
      // Viewers always poll. Admin also polls to pick up changes from other devices.
      pullFromServer({ force: false }).catch(() => {});
    }, POLL_MS);
  }

  async function pullFromServer({ force } = { force: false }){
    if (isSyncing) return;
    isSyncing = true;
    try{
      const res = await fetch(API_EXPORT_URL, { cache: 'no-store' });
      if (!res.ok) {
        const t = await res.text().catch(() => '');
        console.error('export failed', res.status, t);
        throw new Error('export failed');
      }
      const data = await res.json();

      // Convert exported format -> app state format
      const serverState = convertExportToState(data);
      if (!serverState.weeks?.length){
        console.warn('No valid weeks from server. Check weeks sheet headers: id,startDate');
        toast('ì£¼ì°¨ ë°ì´í„°ê°€ ë¹„ì–´ìˆê±°ë‚˜ í˜•ì‹ì´ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤(weeks ì‹œíŠ¸ í™•ì¸)');
      }
      const serverHash = stableHash(serverState);
      if (!force && serverHash === lastServerHash) return;

      // If admin has local unsynced edits, prefer local unless forced.
      // In this simple version, admin push happens on every persist, so we just accept server.
      state = migrateState(serverState) || serverState;
      lastServerHash = serverHash;

      // Save locally without pushing back (avoid loop)
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));

      // Keep selected IDs valid
      hydrateSelectors();
      refreshAll();

    } finally {
      isSyncing = false;
    }
  }

  async function pushToServer(){
    // Push current state to server
    const payload = convertStateToImport(state);

    // IMPORTANT: Apps Script Web Appì€ CORS/ë¦¬ë‹¤ì´ë ‰íŠ¸ íŠ¹ì„± ë•Œë¬¸ì—
    // ë¸Œë¼ìš°ì € fetchì—ì„œ "opaque" ì‘ë‹µì´ ë‚˜ì˜¤ëŠ” ê²½ìš°ê°€ ìˆìŠµë‹ˆë‹¤.
    // ì´ë•Œë„ ë„¤íŠ¸ì›Œí¬ ë ˆë²¨ì—ì„œ ì„±ê³µí–ˆì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ, push í›„ì—ëŠ” ë°˜ë“œì‹œ exportë¡œ ì¬ê²€ì¦í•©ë‹ˆë‹¤.

    try{
      const res = await fetch(API_IMPORT_URL, {
        method: 'POST',
        mode: 'cors',
        cache: 'no-store',
        redirect: 'follow',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      let text = '';
      try{ text = await res.text(); }catch{}

      // type === 'opaque' ì¸ ê²½ìš° statusë¥¼ ì‹ ë¢°í•  ìˆ˜ ì—†ì–´ì„œ ì‹¤íŒ¨ë¡œ ë‹¨ì •í•˜ì§€ ì•ŠìŒ
      if (res.type !== 'opaque' && !res.ok){
        console.error('import failed', res.status, text);
        throw new Error(`import failed: ${res.status}`);
      }

      // After push, pull once to ensure we are consistent
      await pullFromServer({ force: true });
    }catch(err){
      console.error('pushToServer error', err);
      toast('ê³µìš©DB ì €ì¥ ì‹¤íŒ¨(ë„¤íŠ¸ì›Œí¬/ê¶Œí•œ/ìŠ¤í¬ë¦½íŠ¸ í™•ì¸)');
      throw err;
    }
  }

  function convertExportToState(exported){
    // exported: {members, places, weeks, assignments}
    // NOTE: sheets headers must match. weeks sheet uses `startDate`.
    const members = (exported.members || []).map(m => ({
      id: String(m.id || ''),
      name: String(m.name || ''),
      color: String(m.color || '#60a5fa'),
      active: String(m.active).toLowerCase() !== 'false'
    })).filter(m => m.id && m.name);

    const places = (exported.places || []).map(p => ({
      id: String(p.id || ''),
      name: String(p.name || ''),
      category: String(p.category || 'bookstore'),
      active: String(p.active).toLowerCase() !== 'false'
    })).filter(p => p.id && p.name);

    const weeks = (exported.weeks || []).map(w => {
      const id = String(w.id || w.weekId || '');
      const startDate = String(w.startDate || w.week1 || w.start_date || w.start || '');
      return {
        id,
        startDate,
        assignments: {},
        warnings: {}
      };
    }).filter(w => w.id && /^\d{4}-\d{2}-\d{2}$/.test(w.startDate));

    // Build assignment map: week.assignments[placeId][dateKey] = [memberIds]
    const weekMap = new Map(weeks.map(w => [w.id, w]));
    (exported.assignments || []).forEach(a => {
      const weekId = String(a.weekId || '');
      const dateKey = String(a.dateKey || '');
      const placeId = String(a.placeId || '');
      const memberIds = String(a.memberIds || '').split(',').map(s => s.trim()).filter(Boolean);
      const week = weekMap.get(weekId);
      if (!week || !dateKey || !placeId) return;
      week.assignments[placeId] ||= {};
      week.assignments[placeId][dateKey] = memberIds;
    });

    return {
      version: 3,
      members,
      places,
      weeks
    };
  }

  function convertStateToImport(st){
    // import format expected by Apps Script: {members, places, weeks, assignments}
    const members = (st.members || []).map(m => ({
      id: m.id,
      name: m.name,
      color: m.color,
      active: m.active
    }));

    const places = (st.places || []).map(p => ({
      id: p.id,
      name: p.name,
      category: p.category,
      active: (p.active !== false)
    }));

    const weeks = (st.weeks || []).map(w => ({
      id: w.id,
      startDate: w.startDate
    }));

    const assignments = [];
    (st.weeks || []).forEach(w => {
      const dates = getWeekDateKeys(w.startDate);
      (st.places || []).forEach(p => {
        dates.forEach(dk => {
          const arr = w.assignments?.[p.id]?.[dk] || [];
          if (arr.length){
            assignments.push({
              weekId: w.id,
              dateKey: dk,
              placeId: p.id,
              memberIds: arr.join(',')
            });
          }
        });
      });
    });

    return { members, places, weeks, assignments };
  }

  function toast(msg){
    el.toast.textContent = msg;
    el.toast.classList.add('show');
    clearTimeout(toast._t);
    toast._t = setTimeout(() => el.toast.classList.remove('show'), 2200);
  }

  function openModal(id){
    const m = document.getElementById(id);
    if (!m) return;
    m.classList.add('open');
    if (id === 'modalAdmin'){
      updateRoleUI();
      el.adminPw.focus();
    }
  }

  function closeModal(id){
    const m = document.getElementById(id);
    if (!m) return;
    m.classList.remove('open');
  }

  // Close modal on backdrop click
  document.querySelectorAll('.modalBackdrop').forEach(back => {
    back.addEventListener('click', (e) => {
      if (e.target === back) back.classList.remove('open');
    });
  });

  function escapeHtml(str){
    return String(str)
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'",'&#39;');
  }

  function cryptoId(){
    // kept for backward compatibility
    return randId();
  }

  function applyUrlParams(){
    const sp = new URLSearchParams(location.search);
    let view = sp.get('view');
    // ëª¨ë°”ì¼ì€ ê¸°ë³¸ ì¹´ë“œ ë·°
    if (!view && window.matchMedia && window.matchMedia('(max-width: 720px)').matches) view = 'weekCards';
    const week = sp.get('week');
    const person = sp.get('person');
    const place = sp.get('place');

    if (view && ['week','weekCards','person','place','month'].includes(view)) ui.view = view;
    if (week) ui.weekId = week;
    if (person) ui.personId = person;
    if (place) ui.placeId = place;

    // initial view is applied during init
  }

  function syncUrlParams(){
    const url = new URL(location.href);
    url.searchParams.set('view', ui.view);
    if (ui.weekId) url.searchParams.set('week', ui.weekId);
    if (ui.personId) url.searchParams.set('person', ui.personId);
    if (ui.placeId) url.searchParams.set('place', ui.placeId);
    history.replaceState(null, '', url);
  }

  // Register SW for PWA
  if ('serviceWorker' in navigator){
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./sw.js').catch(() => {});
    });
  }

})();
</script>
</body>
</html>
